{% extends "base.html" %}
{% block content %}
  <div class="container-fluid">
    <div class="row">
      <!-- Columna principal -->
      <div class="col-lg-8 col-xl-9">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h2><i class="fas fa-eye"></i> Vista Previa del Proceso de Asignación</h2>
          <a href="{% url 'organizar_grupos' torneo.id %}" class="btn btn-outline-secondary">
            <i class="fas fa-arrow-left"></i> Volver
          </a>
        </div>
        <h5 class="text-muted mb-4">{{ torneo.nombre }}</h5>
        
        {% if messages %}
          {% for message in messages %}
            <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
          {% endfor %}
        {% endif %}

        <!-- Panel de control compacto -->
        <div class="card mb-4 shadow-sm">
          <div class="card-header bg-primary text-white">
            <div class="row align-items-center">
              <div class="col-md-8">
                <h6 class="mb-0">
                  <i class="fas fa-play-circle"></i> 
                  <span id="tituloEtapa">Preparando vista previa...</span>
                </h6>
                <small id="descripcionEtapa">Cargando proceso de asignación</small>
              </div>
              <div class="col-md-4 text-end">
                <small class="me-2">Velocidad:</small>
                <select class="form-select form-select-sm d-inline-block w-auto" id="selectVelocidad" style="width: 90px;">
                  <option value="3000">Lenta</option>
                  <option value="2000" selected>Normal</option>
                  <option value="1000">Rápida</option>
                  <option value="500">Muy Rápida</option>
                </select>
              </div>
            </div>
          </div>
          <div class="card-body">
            <!-- Barra de progreso -->
            <div class="progress mb-3" style="height: 8px;">
              <div class="progress-bar progress-bar-striped" id="barraProgreso" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
            </div>
            
            <!-- Controles de navegación simplificados -->
            <div class="d-flex justify-content-between align-items-center">
              <button class="btn btn-outline-primary" id="btnAnterior" disabled>
                <i class="fas fa-chevron-left"></i> Paso anterior
              </button>
              
              <div class="text-center">
                <button class="btn btn-success" id="btnAutoplay" title="Reproducir automáticamente">
                  <i class="fas fa-play"></i> <span id="autoplayText">Autoplay</span>
                </button>
                <button class="btn btn-outline-secondary ms-2" id="btnReiniciar" title="Volver al inicio">
                  <i class="fas fa-refresh"></i>
                </button>
              </div>
              
              <button class="btn btn-primary" id="btnSiguiente">
                Siguiente paso <i class="fas fa-chevron-right"></i>
              </button>
            </div>
          </div>
        </div>

        <!-- Área de contenido principal -->
        <div id="contenidoPrincipal">
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Cargando...</span>
            </div>
            <p class="mt-2">Preparando vista previa del proceso de asignación...</p>
          </div>
        </div>
      </div>
      
      <!-- Sidebar de información -->
      <div class="col-lg-4 col-xl-3">
        <div class="position-sticky" style="top: 20px;">
          <!-- Botón para colapsar en dispositivos medianos -->
          <div class="d-lg-none mb-2">
            <button class="btn btn-outline-info btn-sm w-100" type="button" data-bs-toggle="collapse" data-bs-target="#sidebarInfo" aria-expanded="false" aria-controls="sidebarInfo">
              <i class="fas fa-info-circle"></i> Mostrar/Ocultar Información
            </button>
          </div>
          
          <div class="collapse d-lg-block" id="sidebarInfo">
            <div class="card border-info shadow-sm">
              <div class="card-header bg-info text-white">
                <h6 class="mb-0"><i class="fas fa-info-circle"></i> Información del Torneo</h6>
              </div>
              <div class="card-body">
                <div class="row g-2 mb-3">
                  <div class="col-6"><strong>Participantes:</strong></div>
                  <div class="col-6 text-end">{{ num_participantes }}</div>
                  <div class="col-6"><strong>Grupos:</strong></div>
                  <div class="col-6 text-end">{{ total_grupos }}</div>
                  <div class="col-6"><strong>Modalidad:</strong></div>
                  <div class="col-6 text-end">
                    <small class="badge bg-{% if tiene_cabezas_serie %}warning{% else %}success{% endif %}">
                      {% if tiene_cabezas_serie %}Con Cabezas{% else %}Automática{% endif %}
                    </small>
                  </div>
                </div>
                
                <hr class="my-3">
                
                <h6 class="mb-2"><i class="fas fa-list"></i> Navegación Rápida</h6>
                <div class="d-grid gap-2">
                  <button class="btn btn-outline-primary btn-sm" onclick="saltarA('lista_original')">
                    <i class="fas fa-list"></i> Lista Original
                  </button>
                  {% if tiene_cabezas_serie %}
                  <button class="btn btn-outline-warning btn-sm" onclick="saltarA('cabezas_serie')">
                    <i class="fas fa-crown"></i> Cabezas de Serie
                  </button>
                  {% endif %}
                  <button class="btn btn-outline-info btn-sm" onclick="saltarA('lista_randomizada')">
                    <i class="fas fa-random"></i> Lista Aleatoria
                  </button>
                  <button class="btn btn-outline-success btn-sm" onclick="saltarA('grupos_finales')">
                    <i class="fas fa-check-circle"></i> Resultado Final
                  </button>
                </div>
                
                <hr class="my-3">
                
                <h6 class="mb-2"><i class="fas fa-keyboard"></i> Atajos de Teclado</h6>
                <div class="small text-muted">
                  <div class="d-flex justify-content-between mb-1">
                    <span>← →</span>
                    <span>Navegar</span>
                  </div>
                  <div class="d-flex justify-content-between mb-1">
                    <span>Espacio</span>
                    <span>Play/Pausa</span>
                  </div>
                  <div class="d-flex justify-content-between">
                    <span>Home</span>
                    <span>Reiniciar</span>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    .jugador-card {
      transition: all 0.4s ease;
      border: 2px solid transparent;
      background: white;
    }
    .jugador-destacado {
      border-color: #007bff !important;
      background-color: #e3f2fd !important;
      transform: scale(1.05);
      box-shadow: 0 4px 8px rgba(0,123,255,0.3);
    }
    .grupo-destino {
      border: 3px dashed #28a745 !important;
      background-color: #d4edda !important;
      animation: pulse 1s infinite;
    }
    .fade-in {
      animation: fadeIn 0.6s ease-in;
    }
    .slide-in {
      animation: slideIn 0.5s ease-out;
    }
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateX(-20px); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.02); }
      100% { transform: scale(1); }
    }
    .lista-participantes {
      max-height: 500px;
      overflow-y: auto;
    }
    .numero-paso {
      position: absolute;
      top: -10px;
      left: -10px;
      background: #6c757d;
      color: white;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      font-size: 12px;
      z-index: 10;
      border: 3px solid white;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .card-paso {
      position: relative;
      margin-top: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
    }
    
    /* Estilos para los controles compactos */
    .btn-group-sm .btn {
      font-size: 0.8rem;
      padding: 0.375rem 0.5rem;
    }
    
    /* Sidebar responsivo */
    .position-sticky {
      top: 20px !important;
    }
    
    @media (max-width: 991.98px) {
      .position-sticky {
        position: relative !important;
        top: auto !important;
        margin-top: 20px;
      }
    }
    
    /* Animación para las barras de progreso */
    .progress-bar {
      transition: width 0.6s ease;
    }
    
    /* Efectos hover para los botones de navegación */
    .btn-outline-primary:hover, .btn-outline-warning:hover, 
    .btn-outline-info:hover, .btn-outline-success:hover {
      transform: translateY(-1px);
      transition: transform 0.2s ease;
    }
    
    /* Mejora para el scrollbar */
    .lista-participantes::-webkit-scrollbar {
      width: 6px;
    }
    .lista-participantes::-webkit-scrollbar-track {
      background: #f8f9fa;
      border-radius: 3px;
    }
    .lista-participantes::-webkit-scrollbar-thumb {
      background: #dee2e6;
      border-radius: 3px;
    }
    .lista-participantes::-webkit-scrollbar-thumb:hover {
      background: #adb5bd;
    }
    
    /* Mejor espaciado para el contenido principal */
    #contenidoPrincipal {
      min-height: 400px;
    }
    
    /* Estilo para el select de velocidad */
    #selectVelocidad {
      border-color: rgba(255,255,255,0.3);
      background-color: rgba(255,255,255,0.9);
      color: #495057;
    }
    
    /* Mejora visual para el card de información */
    .card-header.bg-info {
      background: linear-gradient(135deg, #17a2b8, #138496) !important;
    }
    
    .card-header.bg-primary {
      background: linear-gradient(135deg, #007bff, #0056b3) !important;
    }
    
    /* Hover effects para botones del sidebar */
    .card-body .btn:hover {
      transform: translateX(3px);
      transition: transform 0.2s ease;
    }
    
    /* Mejoras adicionales para dispositivos móviles */
    @media (max-width: 576px) {
      .card-header .row {
        flex-direction: column;
        gap: 10px;
      }
      
      .btn-group-sm .btn {
        font-size: 0.75rem;
        padding: 0.25rem 0.4rem;
      }
      
      #selectVelocidad {
        width: 80px !important;
        font-size: 0.75rem;
      }
      
      .d-grid.gap-2 {
        gap: 0.5rem !important;
      }
      
      .numero-paso {
        width: 30px;
        height: 30px;
        font-size: 11px;
      }
    }
    
    /* Mejorar la visualización del sidebar en tablets */
    @media (min-width: 768px) and (max-width: 991.98px) {
      .position-sticky .card {
        margin-bottom: 20px;
      }
    }
    
    /* Estilos para el diagrama de serpenteo */
    .serpenteo-diagram {
      background: rgba(255,255,255,0.8);
      border-radius: 8px;
      padding: 15px;
      border: 1px solid #dee2e6;
    }
    .serpenteo-diagram .badge {
      font-size: 0.7rem;
      padding: 0.25rem 0.4rem;
      margin: 0.1rem;
    }
  </style>

  <script>
    let procesoAsignacion = {
      paso: 0,
      pasos: [],
      isPlaying: false,
      playInterval: null,
      velocidad: 2000
    };

    document.addEventListener('DOMContentLoaded', function() {
      cargarDatosVistaPrevia();
      
      // Event listeners
      document.getElementById('btnSiguiente').addEventListener('click', siguientePaso);
      document.getElementById('btnAnterior').addEventListener('click', pasoAnterior);
      document.getElementById('btnAutoplay').addEventListener('click', toggleReproduccion);
      document.getElementById('btnReiniciar').addEventListener('click', reiniciarVistaPrevia);
      
      // Event listener para el control de velocidad
      document.getElementById('selectVelocidad').addEventListener('change', function(e) {
        cambiarVelocidad(parseInt(e.target.value));
      });
      
      // Controles de teclado
      document.addEventListener('keydown', function(e) {
        switch(e.key) {
          case 'ArrowLeft':
            e.preventDefault();
            pasoAnterior();
            break;
          case 'ArrowRight':
            e.preventDefault();
            siguientePaso();
            break;
          case ' ':
            e.preventDefault();
            toggleReproduccion();
            break;
          case 'Home':
            e.preventDefault();
            reiniciarVistaPrevia();
            break;
        }
      });
    });

    function cargarDatosVistaPrevia() {
      // Mostrar indicador de carga más detallado
      document.getElementById('contenidoPrincipal').innerHTML = `
        <div class="text-center py-5">
          <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Cargando...</span>
          </div>
          <h5 class="text-muted">Generando vista previa del proceso</h5>
          <p class="text-muted">Esto puede tomar unos segundos...</p>
        </div>`;

      fetch(`/torneos/{{ torneo.id }}/vista-previa-asignacion/`)
        .then(response => {
          if (!response.ok) {
            throw new Error(`Error HTTP: ${response.status} - ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          if (data.error) {
            throw new Error(data.error);
          }
          
          if (!data.pasos || data.pasos.length === 0) {
            throw new Error('No se encontraron pasos para mostrar');
          }
          
          procesoAsignacion.pasos = data.pasos;
          procesoAsignacion.paso = 0;
          
          // Mostrar mensaje de éxito temporal
          document.getElementById('contenidoPrincipal').innerHTML = `
            <div class="alert alert-success text-center">
              <i class="fas fa-check-circle fs-1 mb-2"></i>
              <h5>¡Vista previa generada con éxito!</h5>
              <p>Se encontraron ${data.pasos.length} pasos en el proceso de asignación</p>
            </div>`;
          
          // Después de un momento, mostrar el primer paso
          setTimeout(() => {
            mostrarPaso(0);
            actualizarControles();
          }, 1500);
        })
        .catch(error => {
          console.error('Error:', error);
          document.getElementById('contenidoPrincipal').innerHTML = 
            `<div class="alert alert-danger">
              <div class="row align-items-center">
                <div class="col-auto">
                  <i class="fas fa-exclamation-triangle fs-2"></i>
                </div>
                <div class="col">
                  <h5 class="alert-heading">Error al cargar la vista previa</h5>
                  <p class="mb-2">${error.message}</p>
                  <hr>
                  <div class="d-flex gap-2">
                    <button class="btn btn-outline-danger btn-sm" onclick="cargarDatosVistaPrevia()">
                      <i class="fas fa-redo"></i> Reintentar
                    </button>
                    <a href="{% url 'organizar_grupos' torneo.id %}" class="btn btn-outline-secondary btn-sm">
                      <i class="fas fa-arrow-left"></i> Volver
                    </a>
                  </div>
                </div>
              </div>
            </div>`;
        });
    }

    function mostrarPaso(numeroPaso) {
      if (numeroPaso < 0 || numeroPaso >= procesoAsignacion.pasos.length) return;
      
      const paso = procesoAsignacion.pasos[numeroPaso];
      
      // Actualizar título y descripción
      document.getElementById('tituloEtapa').textContent = `Paso ${numeroPaso + 1}: ${paso.titulo}`;
      document.getElementById('descripcionEtapa').textContent = paso.descripcion;
      
      // Actualizar barra de progreso
      const progreso = ((numeroPaso + 1) / procesoAsignacion.pasos.length) * 100;
      document.getElementById('barraProgreso').style.width = `${progreso}%`;
      document.getElementById('barraProgreso').setAttribute('aria-valuenow', progreso);
      
      // Mostrar contenido específico del paso
      let html = '';
      switch(paso.tipo) {
        case 'lista_original':
          html = generarListaParticipantes(paso.participantes, 'Lista Original de Participantes', 'primary', numeroPaso + 1);
          break;
        case 'lista_randomizada':
          html = generarListaParticipantes(paso.participantes, 'Lista Aleatorizada (Shuffle)', 'warning', numeroPaso + 1);
          break;
        case 'cabezas_serie':
          html = generarCabezasSerie(paso.cabezas, paso.primera_linea, paso.segunda_linea, numeroPaso + 1);
          break;
        case 'asignacion_serpenteo':
          html = generarAsignacionSerpenteo(paso.grupos, paso.jugador_actual, paso.grupo_actual, numeroPaso + 1);
          break;
        case 'grupos_finales':
          html = generarGruposFinales(paso.grupos, numeroPaso + 1);
          break;
      }
      
      document.getElementById('contenidoPrincipal').innerHTML = html;
      procesoAsignacion.paso = numeroPaso;
      actualizarControles();
      
      // Scroll al top suavemente
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      // Reproducir sonido suave para indicar cambio (opcional)
      if (window.Audio && numeroPaso > 0) {
        try {
          // Solo un pequeño beep suave
          const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmEcBClzy/DKfiwHK3zN8Ny');
          audio.volume = 0.1;
          audio.play().catch(() => {}); // Ignorar errores de reproducción
        } catch (e) {
          // Ignorar errores de audio
        }
      }
    }

    function generarListaParticipantes(participantes, titulo, color, numeroPaso) {
      // Generar texto explicativo según el paso
      let textoExplicativo = '';
      if (titulo.includes('Original')) {
        textoExplicativo = `
          <div class="alert alert-info mb-3">
            <i class="fas fa-info-circle"></i>
            <strong>¿Qué está pasando?</strong><br>
            Esta es la lista de participantes tal como fueron registrados en el torneo. El orden se basa en la secuencia de inscripción.
          </div>`;
      } else if (titulo.includes('Aleatorizada')) {
        textoExplicativo = `
          <div class="alert alert-warning mb-3">
            <i class="fas fa-random"></i>
            <strong>¿Qué está pasando?</strong><br>
            Los participantes fueron mezclados aleatoriamente usando un algoritmo de "shuffle". Esto garantiza que la asignación sea completamente imparcial.
          </div>`;
      }
      
      return `
        <div class="card card-paso border-${color} fade-in">
          <div class="numero-paso">${numeroPaso}</div>
          <div class="card-header bg-${color} text-white">
            <h5 class="mb-0">${titulo}</h5>
            <small>Total: ${participantes.length} participantes</small>
          </div>
          <div class="card-body lista-participantes">
            ${textoExplicativo}
            <div class="row g-2">
              ${participantes.map((p, index) => `
                <div class="col-md-6 col-lg-4">
                  <div class="card jugador-card border-light slide-in" style="animation-delay: ${index * 0.1}s">
                    <div class="card-body p-2">
                      <div class="d-flex justify-content-between align-items-center">
                        <span><strong>${index + 1}.</strong> ${p.nombre}</span>
                        <small class="badge bg-light text-dark">${p.categoria}</small>
                      </div>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>`;
    }

    function generarCabezasSerie(todasCabezas, primeraLinea, segundaLinea, numeroPaso) {
      let explicacion = '';
      let contenidoPrimeraLinea = '';
      let contenidoSegundaLinea = '';
      
      // Generar explicación basada en lo que hay
      if (primeraLinea && primeraLinea.length > 0 && segundaLinea && segundaLinea.length > 0) {
        explicacion = `
          <div class="alert alert-success mb-3">
            <i class="fas fa-crown"></i>
            <strong>¿Cómo se asignan las cabezas de serie?</strong><br>
            <strong>Primera línea:</strong> Se asignan en orden secuencial (1° → Grupo 1, 2° → Grupo 2, etc.) en la posición 1 de cada grupo.<br>
            <strong>Segunda línea:</strong> Se asignan en orden serpenteo reverso (1° → Último grupo, 2° → Penúltimo grupo, etc.) en la posición 2 de cada grupo.
            Esto garantiza una distribución equilibrada respetando el patrón de serpenteo.
          </div>`;
      } else if (primeraLinea && primeraLinea.length > 0) {
        explicacion = `
          <div class="alert alert-success mb-3">
            <i class="fas fa-crown"></i>
            <strong>¿Cómo se asignan las cabezas de serie?</strong><br>
            Las cabezas de serie se asignan en orden numérico: 1° Cabeza → Grupo 1, 2° Cabeza → Grupo 2, 3° Cabeza → Grupo 3, y así sucesivamente.
            Esto garantiza que los mejores jugadores estén distribuidos equitativamente.
          </div>`;
      }
      
      // Generar contenido para primera línea
      if (primeraLinea && primeraLinea.length > 0) {
        contenidoPrimeraLinea = `
          <div class="mb-4">
            <h6 class="text-success mb-3"><i class="fas fa-crown"></i> Primera Línea (Posición 1)</h6>
            <div class="row g-3">
              ${primeraLinea.map((cabeza, index) => `
                <div class="col-md-6 col-lg-4">
                  <div class="card border-success slide-in" style="animation-delay: ${index * 0.2}s">
                    <div class="card-body text-center p-3">
                      <div class="mb-2">
                        <span class="badge bg-success fs-6 me-2">#${index + 1}</span>
                        <i class="fas fa-crown text-success fs-3"></i>
                      </div>
                      <h6 class="card-title">Grupo ${cabeza.grupo}</h6>
                      <p class="card-text">
                        <strong>${cabeza.nombre}</strong><br>
                        <small class="text-muted">${cabeza.categoria}</small>
                      </p>
                      <small class="badge bg-light text-dark">Posición 1</small>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>`;
      }
      
      // Generar contenido para segunda línea
      if (segundaLinea && segundaLinea.length > 0) {
        contenidoSegundaLinea = `
          <div class="mb-4">
            <h6 class="text-info mb-3"><i class="fas fa-chess-queen"></i> Segunda Línea (Posición 2)</h6>
            <div class="row g-3">
              ${segundaLinea.map((cabeza, index) => `
                <div class="col-md-6 col-lg-4">
                  <div class="card border-info slide-in" style="animation-delay: ${(primeraLinea ? primeraLinea.length : 0) * 0.2 + index * 0.2}s">
                    <div class="card-body text-center p-3">
                      <div class="mb-2">
                        <span class="badge bg-info fs-6 me-2">#${index + 1}</span>
                        <i class="fas fa-chess-queen text-info fs-3"></i>
                      </div>
                      <h6 class="card-title">Grupo ${cabeza.grupo}</h6>
                      <p class="card-text">
                        <strong>${cabeza.nombre}</strong><br>
                        <small class="text-muted">${cabeza.categoria}</small>
                      </p>
                      <small class="badge bg-light text-dark">Posición 2</small>
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>`;
      }
      
      // Generar resumen de asignación
      let resumenAsignacion = '';
      if (todasCabezas && todasCabezas.length > 0) {
        resumenAsignacion = `
          <div class="mt-3">
            <div class="alert alert-info">
              <h6><i class="fas fa-info-circle"></i> Resumen de Asignaciones:</h6>
              <div class="row">
                ${todasCabezas.map((cabeza) => `
                  <div class="col-md-6 col-lg-4 mb-2">
                    <strong>${cabeza.nombre}:</strong> Grupo ${cabeza.grupo}, Posición ${cabeza.posicion}
                  </div>
                `).join('')}
              </div>
            </div>
          </div>`;
      }
      
      return `
        <div class="card card-paso border-success fade-in">
          <div class="numero-paso">${numeroPaso}</div>
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-crown"></i> Cabezas de Serie Seleccionadas</h5>
            <small>
              ${primeraLinea && segundaLinea && primeraLinea.length > 0 && segundaLinea.length > 0 
                ? `${primeraLinea.length} de primera línea y ${segundaLinea.length} de segunda línea` 
                : `${todasCabezas ? todasCabezas.length : 0} cabezas de serie asignadas`}
            </small>
          </div>
          <div class="card-body">
            ${explicacion}
            ${contenidoPrimeraLinea}
            ${contenidoSegundaLinea}
            ${resumenAsignacion}
          </div>
        </div>`;
    }

    function generarAsignacionSerpenteo(grupos, jugadorActual, grupoActual, numeroPaso) {
      let alertaJugador = '';
      let textoExplicativo = '';
      
      // Explicación del proceso de serpenteo
      if (numeroPaso === 4 || (jugadorActual && grupos.flat().length <= 3)) {
        textoExplicativo = `
          <div class="alert alert-info mb-3">
            <div class="row align-items-center">
              <div class="col-auto">
                <i class="fas fa-route fs-2"></i>
              </div>
              <div class="col">
                <h6><strong>¿Qué es el serpenteo?</strong></h6>
                <p class="mb-2">El serpenteo asigna jugadores de forma equilibrada siguiendo este patrón:</p>
                <div class="row">
                  <div class="col-md-6">
                    <strong>Orden de asignación:</strong><br>
                    <small class="text-muted">
                      <strong>Posición 1:</strong> A → B → C → D → E<br>
                      <strong>Posición 2:</strong> E → D → C → B → A<br>
                      <strong>Posición 3:</strong> A → B → C → D → E<br>
                      <strong>Posición 4:</strong> E → D → C → B → A<br>
                    </small>
                  </div>
                  <div class="col-md-6">
                    <strong>Patrón:</strong><br>
                    <small class="text-muted">
                      Se llenan las posiciones una por una.<br>
                      La posición 1 va de izquierda a derecha,<br>
                      la posición 2 de derecha a izquierda,<br>
                      creando un patrón "serpiente"<br>
                      que equilibra la fuerza de<br>
                      todos los grupos.
                    </small>
                  </div>
                </div>
                <div class="mt-3">
                  <h6><strong>Ejemplo visual (5 grupos):</strong></h6>
                  <div class="d-flex justify-content-center">
                    <div class="serpenteo-diagram">
                      <div class="row mb-1">
                        <div class="col text-center"><small class="badge bg-warning">1°→A</small></div>
                        <div class="col text-center"><small class="badge bg-warning">2°→B</small></div>
                        <div class="col text-center"><small class="badge bg-warning">3°→C</small></div>
                        <div class="col text-center"><small class="badge bg-warning">4°→D</small></div>
                        <div class="col text-center"><small class="badge bg-warning">5°→E</small></div>
                      </div>
                      <div class="row mb-1">
                        <div class="col text-center"><small class="badge bg-primary">10°→A</small></div>
                        <div class="col text-center"><small class="badge bg-primary">9°→B</small></div>
                        <div class="col text-center"><small class="badge bg-primary">8°→C</small></div>
                        <div class="col text-center"><small class="badge bg-primary">7°→D</small></div>
                        <div class="col text-center"><small class="badge bg-primary">6°→E</small></div>
                      </div>
                      <div class="row mb-1">
                        <div class="col text-center"><small class="badge bg-success">11°→A</small></div>
                        <div class="col text-center"><small class="badge bg-success">12°→B</small></div>
                        <div class="col text-center"><small class="badge bg-success">13°→C</small></div>
                        <div class="col text-center"><small class="badge bg-success">14°→D</small></div>
                        <div class="col text-center"><small class="badge bg-success">15°→E</small></div>
                      </div>
                      <div class="text-center mt-2">
                        <small class="text-muted">
                          <i class="fas fa-arrow-right text-warning"></i> Posición 1 (1-5)<br>
                          <i class="fas fa-arrow-left text-primary"></i> Posición 2 (6-10)<br>
                          <i class="fas fa-arrow-right text-success"></i> Posición 3 (11-15)
                        </small>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>`;
      }
      
      if (jugadorActual) {
        alertaJugador = `
          <div class="alert alert-success mb-3 fade-in">
            <div class="row align-items-center">
              <div class="col-auto">
                <i class="fas fa-check-circle fs-4 text-success"></i>
              </div>
              <div class="col">
                <strong>Último asignado:</strong> ${jugadorActual.nombre} 
                <i class="fas fa-arrow-right mx-2"></i> 
                <strong>Grupo ${grupoActual + 1}</strong>
                <br><small class="text-muted">Posición en el grupo: ${grupos[grupoActual].length}</small>
              </div>
            </div>
          </div>`;
      }

      return `
        <div class="card card-paso border-info fade-in">
          <div class="numero-paso">${numeroPaso}</div>
          <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-users"></i> Asignación Serpenteo</h5>
            <small>Distribución equilibrada usando el patrón serpiente</small>
          </div>
          <div class="card-body">
            ${textoExplicativo}
            ${alertaJugador}
            <div class="row g-3">
              ${grupos.map((grupo, index) => {
                const esGrupoDestino = index === grupoActual;
                const participantesRecientes = grupo.slice(-3); // Últimos 3 para destacar
                
                return `
                  <div class="col-md-6 col-lg-4">
                    <div class="card ${esGrupoDestino ? 'grupo-destino' : 'border-secondary'}">
                      <div class="card-header bg-secondary text-white text-center">
                        <h6 class="mb-0">Grupo ${index + 1}</h6>
                        <small>${grupo.length} participante${grupo.length !== 1 ? 's' : ''}</small>
                      </div>
                      <div class="card-body p-2" style="max-height: 200px; overflow-y: auto;">
                        ${grupo.map((jugador, pos) => {
                          const esReciente = participantesRecientes.includes(jugador);
                          return `
                            <div class="d-flex justify-content-between align-items-center border-bottom py-2 ${esReciente ? 'jugador-destacado fade-in' : ''}">
                              <span>
                                <strong>${pos + 1}.</strong> ${jugador.nombre}
                                ${jugador.es_cabeza_serie ? '<i class="fas fa-crown text-warning ms-1"></i>' : ''}
                                ${esReciente ? '<i class="fas fa-star text-success ms-1" title="Recién asignado"></i>' : ''}
                              </span>
                              <small class="badge bg-light text-dark">${jugador.categoria}</small>
                            </div>`;
                        }).join('')}
                        ${grupo.length === 0 ? '<div class="text-center text-muted py-3"><i class="fas fa-users-slash"></i><br>Vacío</div>' : ''}
                      </div>
                    </div>
                  </div>`;
              }).join('')}
            </div>
          </div>
        </div>`;
    }

    function generarGruposFinales(grupos, numeroPaso) {
      return `
        <div class="card card-paso border-success fade-in">
          <div class="numero-paso">${numeroPaso}</div>
          <div class="card-header bg-success text-white">
            <h5 class="mb-0"><i class="fas fa-check-circle"></i> ¡Asignación Completada!</h5>
            <small>Grupos finales listos para el torneo</small>
          </div>
          <div class="card-body">
            <div class="alert alert-success mb-4">
              <div class="row align-items-center">
                <div class="col-auto">
                  <i class="fas fa-trophy fs-1"></i>
                </div>
                <div class="col">
                  <h5 class="alert-heading">¡Proceso Completado!</h5>
                  <p class="mb-0">
                    Todos los participantes han sido asignados exitosamente. 
                    La distribución se realizó de forma equilibrada y los grupos están listos para comenzar la competencia.
                  </p>
                </div>
              </div>
            </div>
            
            <div class="row g-3">
              ${grupos.map((grupo, index) => {
                const totalJugadores = grupo.length;
                const cabezasSerie = grupo.filter(j => j.es_cabeza_serie).length;
                
                return `
                  <div class="col-md-6 col-lg-4">
                    <div class="card border-success slide-in" style="animation-delay: ${index * 0.1}s">
                      <div class="card-header bg-success text-white text-center">
                        <h6 class="mb-0">
                          <i class="fas fa-users"></i> Grupo ${index + 1}
                        </h6>
                        <small>
                          ${totalJugadores} jugador${totalJugadores !== 1 ? 'es' : ''}
                          ${cabezasSerie > 0 ? ` • ${cabezasSerie} cabeza${cabezasSerie !== 1 ? 's' : ''} de serie` : ''}
                        </small>
                      </div>
                      <div class="card-body p-2">
                        ${grupo.map((jugador, pos) => `
                          <div class="d-flex justify-content-between align-items-center border-bottom py-2">
                            <span>
                              <strong>${pos + 1}.</strong> ${jugador.nombre}
                              ${jugador.es_cabeza_serie ? '<i class="fas fa-crown text-warning ms-1" title="Cabeza de serie"></i>' : ''}
                            </span>
                            <small class="badge bg-light text-dark">${jugador.categoria}</small>
                          </div>
                        `).join('')}
                      </div>
                    </div>
                  </div>`;
              }).join('')}
            </div>
            
            <div class="row mt-4">
              <div class="col-12">
                <div class="card border-info">
                  <div class="card-header bg-info text-white">
                    <h6 class="mb-0"><i class="fas fa-chart-bar"></i> Estadísticas de la Asignación</h6>
                  </div>
                  <div class="card-body">
                    <div class="row text-center">
                      <div class="col-md-3">
                        <div class="border rounded p-3">
                          <h4 class="text-primary">${grupos.length}</h4>
                          <small class="text-muted">Grupos Formados</small>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="border rounded p-3">
                          <h4 class="text-success">${grupos.reduce((total, grupo) => total + grupo.length, 0)}</h4>
                          <small class="text-muted">Total Participantes</small>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="border rounded p-3">
                          <h4 class="text-warning">${grupos.reduce((total, grupo) => total + grupo.filter(j => j.es_cabeza_serie).length, 0)}</h4>
                          <small class="text-muted">Cabezas de Serie</small>
                        </div>
                      </div>
                      <div class="col-md-3">
                        <div class="border rounded p-3">
                          <h4 class="text-info">${Math.round(grupos.reduce((total, grupo) => total + grupo.length, 0) / grupos.length * 10) / 10}</h4>
                          <small class="text-muted">Promedio por Grupo</small>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            <div class="text-center mt-4">
              <a href="{% url 'organizar_grupos' torneo.id %}" class="btn btn-success btn-lg">
                <i class="fas fa-arrow-left"></i> Volver a Organizar Grupos
              </a>
            </div>
          </div>
        </div>`;
    }

    function siguientePaso() {
      if (procesoAsignacion.paso < procesoAsignacion.pasos.length - 1) {
        mostrarPaso(procesoAsignacion.paso + 1);
      }
    }

    function pasoAnterior() {
      if (procesoAsignacion.paso > 0) {
        mostrarPaso(procesoAsignacion.paso - 1);
      }
    }

    function toggleReproduccion() {
      if (procesoAsignacion.isPlaying) {
        pausarReproduccion();
      } else {
        // Si estamos al final, reiniciar desde el principio
        if (procesoAsignacion.paso === procesoAsignacion.pasos.length - 1) {
          reiniciarVistaPrevia();
          setTimeout(() => iniciarReproduccion(), 500);
        } else {
          iniciarReproduccion();
        }
      }
    }

    function iniciarReproduccion() {
      procesoAsignacion.isPlaying = true;
      actualizarControles();
      
      procesoAsignacion.playInterval = setInterval(() => {
        if (procesoAsignacion.paso < procesoAsignacion.pasos.length - 1) {
          siguientePaso();
        } else {
          pausarReproduccion();
        }
      }, procesoAsignacion.velocidad);
    }

    function pausarReproduccion() {
      procesoAsignacion.isPlaying = false;
      actualizarControles();
      if (procesoAsignacion.playInterval) {
        clearInterval(procesoAsignacion.playInterval);
      }
    }

    function actualizarControles() {
      const btnAnterior = document.getElementById('btnAnterior');
      const btnSiguiente = document.getElementById('btnSiguiente');
      const btnAutoplay = document.getElementById('btnAutoplay');
      const autoplayText = document.getElementById('autoplayText');
      const barraProgreso = document.getElementById('barraProgreso');
      
      // Actualizar estado de botones
      btnAnterior.disabled = procesoAsignacion.paso <= 0;
      btnSiguiente.disabled = procesoAsignacion.paso >= procesoAsignacion.pasos.length - 1;
      
      // Actualizar botón de autoplay
      if (procesoAsignacion.isPlaying) {
        btnAutoplay.innerHTML = '<i class="fas fa-pause"></i> <span id="autoplayText">Pausar</span>';
        btnAutoplay.className = 'btn btn-warning';
      } else {
        btnAutoplay.innerHTML = '<i class="fas fa-play"></i> <span id="autoplayText">Autoplay</span>';
        btnAutoplay.className = 'btn btn-success';
      }
      
      // Actualizar barra de progreso
      const progreso = ((procesoAsignacion.paso + 1) / procesoAsignacion.pasos.length) * 100;
      barraProgreso.style.width = progreso + '%';
      barraProgreso.setAttribute('aria-valuenow', progreso);
    }

    function reiniciarVistaPrevia() {
      pausarReproduccion();
      mostrarPaso(0);
    }

    function saltarA(tipo) {
      const indice = procesoAsignacion.pasos.findIndex(paso => paso.tipo === tipo);
      if (indice !== -1) {
        pausarReproduccion();
        mostrarPaso(indice);
      }
    }
    
    // Función para cambiar velocidad de reproducción
    function cambiarVelocidad(nuevaVelocidad) {
      procesoAsignacion.velocidad = nuevaVelocidad;
      if (procesoAsignacion.isPlaying) {
        pausarReproduccion();
        iniciarReproduccion();
      }
    }

    // Auto-collapse sidebar después de usar navegación rápida en dispositivos pequeños
    window.saltarAOriginal = saltarA;
    window.saltarA = function(tipo) {
      saltarAOriginal(tipo);
      
      // Si estamos en un dispositivo pequeño, colapsar el sidebar
      if (window.innerWidth < 992) {
        setTimeout(() => {
          const sidebarCollapse = document.getElementById('sidebarInfo');
          if (sidebarCollapse && sidebarCollapse.classList.contains('show')) {
            const bsCollapse = new bootstrap.Collapse(sidebarCollapse, {
              toggle: false
            });
            bsCollapse.hide();
          }
        }, 1000);
      }
    };
  </script>
{% endblock %}
