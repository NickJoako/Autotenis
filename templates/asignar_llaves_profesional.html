{% extends "base.html" %}
{% load static %}
{% block content %}
<div class="container-fluid">
  <h2>Asignar Llaves - {{ torneo.nombre }}</h2>
  
  {% if messages %}
    {% for message in messages %}
      <div class="alert alert-{% if message.tags == 'error' %}danger{% else %}success{% endif %} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      </div>
    {% endfor %}
  {% endif %}
  
  <hr>

  <!-- Información del bracket -->
  <div class="row mb-4">
    <div class="col-md-12">
      <div class="card border-primary">
        <div class="card-header bg-primary text-white">
          <h5 class="mb-0"><i class="fas fa-sitemap"></i> Información del Bracket</h5>
        </div>
        <div class="card-body">
          <div class="row">
            <div class="col-md-3">
              <p><strong>Participantes disponibles:</strong> <span class="text-primary">{{ num_participantes }}</span></p>
              <p><strong>Tamaño del bracket:</strong> <span class="text-success">{{ potencia_2_siguiente }}</span></p>
            </div>
            <div class="col-md-3">
              <p><strong>BYEs necesarios:</strong> <span class="text-warning" id="byes-necesarios"></span></p>
              <p><strong>Partidos primera ronda:</strong> <span class="text-info" id="partidos-primera-ronda"></span></p>
            </div>
            <div class="col-md-6">
              <div class="alert alert-info mb-0">
                <small>
                  <i class="fas fa-info-circle"></i>
                  <strong>Instrucciones:</strong> Marca los checkboxes para posiciones BYE, o asigna jugadores específicos. 
                  Las posiciones que dejes vacías se completarán automáticamente con jugadores disponibles.
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="row">
    <!-- Panel izquierdo: Lista de participantes y vista previa -->
    <div class="col-lg-4">
      <div class="card mb-4">
        <div class="card-header bg-success text-white">
          <h5 class="mb-0">
            <i class="fas fa-users"></i> Participantes del Torneo
          </h5>
        </div>
        <div class="card-body">
          <!-- Buscador de jugadores mejorado -->
          <div class="mb-3">
            <label for="filtro-jugadores" class="form-label">
              <i class="fas fa-search"></i> Buscar jugador:
            </label>
            <div class="input-group">
              <input type="text" id="filtro-jugadores" class="form-control" placeholder="Buscar por nombre, apellido o club...">
              <button class="btn btn-outline-secondary" type="button" id="limpiar-filtro">
                <i class="fas fa-times"></i>
              </button>
            </div>
            <div class="mt-2">
              <small class="text-muted">
                <span id="resultados-filtro">{{ jugadores|length }} jugadores encontrados</span>
              </small>
            </div>
          </div>
          
          <!-- Filtros rápidos -->
          <div class="mb-3">
            <div class="btn-group btn-group-sm w-100" role="group">
              <button type="button" class="btn btn-outline-primary filtro-rapido active" data-filtro="todos">
                <i class="fas fa-users"></i> Todos
              </button>
              <button type="button" class="btn btn-outline-success filtro-rapido" data-filtro="disponibles">
                <i class="fas fa-check-circle"></i> Disponibles
              </button>
              <button type="button" class="btn btn-outline-info filtro-rapido" data-filtro="asignados">
                <i class="fas fa-user-check"></i> Asignados
              </button>
            </div>
          </div>
          
          <!-- Controles de ordenamiento -->
          <div class="mb-3">
            <div class="row">
              <div class="col-6">
                <select class="form-select form-select-sm" id="ordenar-por">
                  <option value="nombre">Ordenar por nombre</option>
                  <option value="apellido">Ordenar por apellido</option>
                  <option value="club">Ordenar por club</option>
                  <option value="estado">Ordenar por estado</option>
                </select>
              </div>
              <div class="col-6">
                <select class="form-select form-select-sm" id="orden-direccion">
                  <option value="asc">Ascendente</option>
                  <option value="desc">Descendente</option>
                </select>
              </div>
            </div>
          </div>
          
          <!-- Lista de participantes mejorada -->
          <div id="lista-participantes" style="max-height: 400px; overflow-y: auto;">
            <div class="list-group">
              {% for jugador in jugadores %}
                <div class="list-group-item participante-item" 
                     data-jugador-id="{{ jugador.id }}" 
                     data-jugador-nombre="{{ jugador.nombre|lower }} {{ jugador.apellido|lower }}"
                     data-jugador-club="{% if jugador.club %}{{ jugador.club.nombre|lower }}{% endif %}"
                     data-estado="disponible">
                  <div class="d-flex justify-content-between align-items-center">
                    <div class="flex-grow-1">
                      <div class="d-flex align-items-center mb-1">
                        <strong class="jugador-nombre">{{ jugador.nombre }} {{ jugador.apellido }}</strong>
                        <span class="badge bg-success status-badge ms-2" id="status-{{ jugador.id }}">Disponible</span>
                      </div>
                      {% if jugador.club %}
                        <small class="text-muted">
                          <i class="fas fa-building"></i> {{ jugador.club.nombre }}
                        </small>
                      {% endif %}
                      {% if jugador.genero %}
                        <span class="badge badge-genero ms-1 {% if jugador.genero == 'M' %}bg-primary{% else %}bg-danger{% endif %}">
                          {{ jugador.genero }}
                        </span>
                      {% endif %}
                    </div>
                    <div class="acciones-jugador">
                      <span class="posicion-asignada text-muted small me-2" id="posicion-{{ jugador.id }}" style="display: none;">
                        Pos: <span class="numero-posicion"></span>
                      </span>
                      <button class="btn btn-sm btn-outline-primary asignar-btn" 
                              data-jugador-id="{{ jugador.id }}" 
                              data-jugador-nombre="{{ jugador.nombre }} {{ jugador.apellido }}"
                              title="Asignar a primera posición disponible">
                        <i class="fas fa-plus"></i>
                      </button>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
            
            <!-- Mensaje cuando no hay resultados -->
            <div id="no-resultados" class="text-center text-muted mt-3" style="display: none;">
              <i class="fas fa-search fa-2x mb-2"></i>
              <p>No se encontraron jugadores que coincidan con la búsqueda.</p>
            </div>
          </div>
          
          <!-- Contador de asignaciones -->
          <div class="mt-3 p-3 bg-light rounded" id="contador-asignaciones">
            <h6 class="mb-2"><i class="fas fa-chart-pie"></i> Estado de Asignaciones</h6>
            <div class="row text-center">
              <div class="col-4">
                <div class="border-end">
                  <span class="d-block fw-bold text-success" id="count-disponibles">{{ num_participantes }}</span>
                  <small>Disponibles</small>
                </div>
              </div>
              <div class="col-4">
                <div class="border-end">
                  <span class="d-block fw-bold text-info" id="count-asignados">0</span>
                  <small>Asignados</small>
                </div>
              </div>
              <div class="col-4">
                <span class="d-block fw-bold text-warning" id="count-byes">0</span>
                <small>BYEs</small>
              </div>
            </div>
          </div>
        </div>

        <!-- Vista previa del bracket -->
        <div class="card-header bg-info text-white">
          <h5 class="mb-0">
            <i class="fas fa-trophy"></i> Vista Previa del Bracket
          </h5>
        </div>
        <div class="card-body p-2">
          <!-- Bracket profesional con tournament-bracket -->
          <div id="tournament-bracket" class="tournament-container-small"></div>
        </div>
      </div>
    </div>

    <!-- Panel derecho: Asignación de posiciones -->
    <div class="col-lg-8">
      <form method="post" id="bracket-form">
        {% csrf_token %}
        
        <div class="card">
          <div class="card-header bg-warning">
            <h5 class="mb-0">
              <i class="fas fa-chess-board"></i> Asignación de Posiciones del Bracket
            </h5>
          </div>
          <div class="card-body">
            <!-- Contadores en tiempo real -->
            <div class="alert alert-primary mb-4" id="contador-tiempo-real">
              <div class="row text-center">
                <div class="col-3">
                  <span class="d-block fw-bold text-primary fs-4" id="count-jugadores">0</span>
                  <small>Jugadores Asignados</small>
                </div>
                <div class="col-3">
                  <span class="d-block fw-bold text-warning fs-4" id="count-byes-header">0</span>
                  <small>BYEs Marcados</small>
                </div>
                <div class="col-3">
                  <span class="d-block fw-bold text-info fs-4" id="count-aleatorios">{{ potencia_2_siguiente }}</span>
                  <small>Automáticos</small>
                </div>
                <div class="col-3">
                  <span class="d-block fw-bold text-success fs-4">{{ potencia_2_siguiente }}</span>
                  <small>Total Posiciones</small>
                </div>
              </div>
            </div>

            <!-- Límite de BYEs -->
            <div class="row mb-3">
              <div class="col-md-12">
                <div class="alert alert-warning mb-0" id="alerta-byes-requeridos">
                  <i class="fas fa-info-circle"></i>
                  <strong>BYEs Requeridos:</strong> Para este torneo de <span class="fw-bold">{{ num_participantes }}</span> participantes 
                  necesitas exactamente <span class="fw-bold text-danger" id="byes-requeridos">4</span> BYEs 
                  para completar un bracket de <span class="fw-bold">{{ potencia_2_siguiente }}</span> posiciones.
                  <br><small class="text-muted">
                    <strong>Estado actual:</strong> <span id="estado-byes-texto">No hay BYEs seleccionados</span>
                  </small>
                </div>
              </div>
            </div>
            <!-- Tarjetas de asignación de posiciones -->
            <div class="row" style="max-height: 600px; overflow-y: auto;">
              {% for i in casillas %}
                <div class="col-md-6 col-lg-4 mb-3">
                  <div class="card border-secondary posicion-card" data-posicion="{{ i }}" id="card-posicion-{{ i }}">
                    <div class="card-header bg-secondary text-white text-center">
                      <h6 class="mb-0">Posición {{ i|add:1 }}</h6>
                    </div>
                    <div class="card-body">
                      <!-- Checkbox para BYE -->
                      <div class="form-check mb-3">
                        <input class="form-check-input bye-checkbox" type="checkbox" name="bye_{{ i }}" id="bye_{{ i }}" data-position="{{ i }}">
                        <label class="form-check-label fw-bold" for="bye_{{ i }}">
                          <i class="fas fa-ban text-danger"></i> Esta posición es BYE
                        </label>
                      </div>
                      
                      <!-- Contenedor de búsqueda de jugador -->
                      <div class="search-container" id="search-container-{{ i }}">
                        <input type="text" 
                               class="form-control form-control-sm search-input" 
                               placeholder="Buscar jugador..." 
                               data-position="{{ i }}"
                               autocomplete="off"
                               id="search-{{ i }}">
                        <div class="search-results" data-position="{{ i }}" style="display: none;"></div>
                      </div>
                      
                      <!-- Campo oculto para el valor seleccionado -->
                      <input type="hidden" 
                             name="casilla_{{ i }}" 
                             class="jugador-hidden" 
                             data-position="{{ i }}"
                             value="random">
                      
                      <!-- Mostrar jugador seleccionado -->
                      <div class="selected-player" data-position="{{ i }}" style="display: none;">
                        <div class="alert alert-success d-flex justify-content-between align-items-center mb-0 mt-2">
                          <span class="selected-text"></span>
                          <button type="button" class="btn btn-sm btn-outline-danger clear-selection" data-position="{{ i }}">
                            <i class="fas fa-times"></i>
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              {% endfor %}
            </div>
          </div>
        </div>

        <div class="text-center mt-4">
          <button type="button" class="btn btn-outline-success btn-lg me-2" id="btn-autocompletar-byes">
            <i class="fas fa-magic"></i> Auto-completar BYEs faltantes
          </button>
          <button type="button" class="btn btn-outline-info btn-lg me-2" id="btn-asignacion-aleatoria">
            <i class="fas fa-random"></i> Asignación Aleatoria Inteligente
          </button>
          <button type="submit" class="btn btn-primary btn-lg me-3" id="btn-confirmar">
            <i class="fas fa-check"></i> Confirmar Asignación
          </button>
          <a href="{% url 'modalidad_llaves' torneo.id %}" class="btn btn-secondary btn-lg">
            <i class="fas fa-arrow-left"></i> Cancelar
          </a>
        </div>
      </form>
      
      <!-- Alertas dinámicas -->
      <div id="alertas-container" class="mt-3"></div>
    </div>
  </div>
</div>

<!-- CDN de las librerías -->
<script src="https://cdn.jsdelivr.net/npm/d3@7.8.5/dist/d3.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tournament-bracket@1.0.0/dist/tournament-bracket.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bracket-tree@1.1.0/dist/bracket-tree.min.js"></script>

<style>
/* Estilos para el bracket */
.tournament-container {
  width: 100%;
  height: 500px;
  overflow: auto;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f8f9fa;
}

.bracket-select:focus {
  border-color: #0d6efd;
  box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
}

.select-error {
  border-color: #dc3545 !important;
  box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.25) !important;
  animation: shake 0.5s ease-in-out;
}

.highlighted {
  border-color: #28a745 !important;
  box-shadow: 0 0 0 0.2rem rgba(40, 167, 69, 0.25) !important;
  animation: pulse 1s ease-in-out;
}

.bye-warning {
  border-color: #ffc107 !important;
  box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25) !important;
}

/* Estilos para las tarjetas de posiciones */
.posicion-card {
  transition: all 0.3s ease;
  border-radius: 10px;
}

.posicion-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.posicion-card.bye-selected {
  border-color: #dc3545;
  background-color: #f8d7da;
}

.posicion-card.bye-selected .card-header {
  background-color: #dc3545 !important;
}

.posicion-card.jugador-selected {
  border-color: #28a745;
  background-color: #d4edda;
}

.posicion-card.jugador-selected .card-header {
  background-color: #28a745 !important;
}

/* Vista previa del bracket más pequeña */
.tournament-container-small {
  width: 100%;
  height: 300px;
  overflow: auto;
  border: 1px solid #ddd;
  border-radius: 8px;
  background: #f8f9fa;
  font-size: 10px;
}

/* Resultados de búsqueda en las tarjetas */
.search-results {
  position: absolute;
  top: 100%;
  left: 0;
  right: 0;
  z-index: 1000;
  background: white;
  border: 1px solid #dee2e6;
  border-top: none;
  border-radius: 0 0 8px 8px;
  max-height: 150px;
  overflow-y: auto;
  display: none;
}

.search-result-item {
  padding: 8px 12px;
  cursor: pointer;
  border-bottom: 1px solid #f8f9fa;
  transition: background-color 0.2s ease;
}

.search-result-item:hover {
  background-color: #e3f2fd;
}

.search-result-item:last-child {
  border-bottom: none;
}

/* Búsqueda con contenedor de posición relativa */
.search-container {
  position: relative;
}

/* Estilos para el jugador seleccionado */
.selected-player .alert {
  font-size: 0.9em;
  padding: 8px 12px;
}

.clear-selection {
  padding: 2px 6px;
  font-size: 0.8em;
}

/* Checkbox BYE mejorado */
.bye-checkbox {
  transform: scale(1.3);
  margin-right: 8px;
}

.bye-checkbox:checked + label {
  color: #dc3545;
  font-weight: bold;
}

/* Estilos adicionales para participantes */
.participante-item {
  transition: all 0.2s ease;
}

.participante-item.oculto {
  display: none !important;
}

.participante-item.filtrado {
  background-color: #fff3cd;
  border-left: 3px solid #ffc107;
}

.participante-item.asignado {
  background-color: #d1ecf1;
  border-left: 3px solid #17a2b8;
}

.badge-genero {
  font-size: 0.7em;
}

.posicion-asignada {
  font-size: 0.8em;
  font-weight: bold;
}

/* Estilos para los estados de las tarjetas */
.position-bye {
  background-color: #f8d7da;
  border-color: #dc3545;
}

.position-normal {
  background-color: #ffffff;
  border-color: #dee2e6;
}

/* Contadores en tiempo real */
#contador-tiempo-real {
  border-left: 4px solid #0d6efd;
  background: linear-gradient(135deg, #f8f9ff, #e3f2fd);
}

/* Animaciones */
@keyframes cardPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.02); }
}

.posicion-card.destacar {
  animation: cardPulse 1s ease-in-out;
}

/* Estilos adicionales para la funcionalidad de BYEs */
#btn-autocompletar-byes {
  background: linear-gradient(135deg, #28a745, #20c997);
  border: none;
  color: white;
  transition: all 0.3s ease;
}

#btn-autocompletar-byes:hover {
  background: linear-gradient(135deg, #218838, #17a2b8);
  transform: translateY(-2px);
  box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
}

#alerta-byes-requeridos.alert-success {
  border-left: 4px solid #28a745;
  background: linear-gradient(135deg, #d4edda, #c3e6cb);
}

#alerta-byes-requeridos.alert-warning {
  border-left: 4px solid #ffc107;
  background: linear-gradient(135deg, #fff3cd, #ffeaa7);
}

#alerta-byes-requeridos.alert-danger {
  border-left: 4px solid #dc3545;
  background: linear-gradient(135deg, #f8d7da, #f5c6cb);
}

/* Responsive para pantallas pequeñas */
@media (max-width: 768px) {
  .tournament-container-small {
    height: 200px;
    font-size: 8px;
  }
  
  .posicion-card .card-body {
    padding: 0.75rem;
  }
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Variables globales
    const numParticipantes = {{ num_participantes }};
    const tamanioBracket = {{ potencia_2_siguiente }};
    const jugadores = [
        {% for jugador in jugadores %}
        {
            id: {{ jugador.id }},
            name: "{{ jugador.nombre }} {{ jugador.apellido }}"
        },
        {% endfor %}
    ];
    
    let tournamentBracket = null;
    let bracketTree = null;
    
    // Funciones de filtrado y búsqueda mejoradas
    function inicializarFiltroJugadores() {
        const filtroInput = document.getElementById('filtro-jugadores');
        const limpiarBtn = document.getElementById('limpiar-filtro');
        const resultadosSpan = document.getElementById('resultados-filtro');
        const noResultados = document.getElementById('no-resultados');
        const participantes = document.querySelectorAll('.participante-item');
        
        // Función para aplicar filtros
        function aplicarFiltros() {
            const termino = filtroInput.value.toLowerCase().trim();
            const filtroActivo = document.querySelector('.filtro-rapido.active').dataset.filtro;
            let visibles = 0;
            
            participantes.forEach(item => {
                const nombre = item.dataset.jugadorNombre;
                const club = item.dataset.jugadorClub || '';
                const estado = item.dataset.estado;
                
                // Filtro por texto
                const coincideTexto = termino === '' || 
                    nombre.includes(termino) || 
                    club.includes(termino);
                
                // Filtro por estado
                let coincideEstado = true;
                if (filtroActivo === 'disponibles') {
                    coincideEstado = estado === 'disponible';
                } else if (filtroActivo === 'asignados') {
                    coincideEstado = estado === 'asignado';
                }
                
                if (coincideTexto && coincideEstado) {
                    item.classList.remove('oculto');
                    item.classList.toggle('filtrado', termino !== '');
                    visibles++;
                } else {
                    item.classList.add('oculto');
                    item.classList.remove('filtrado');
                }
            });
            
            // Actualizar contador y mostrar/ocultar mensaje
            resultadosSpan.textContent = `${visibles} jugadores encontrados`;
            noResultados.style.display = visibles === 0 ? 'block' : 'none';
        }
        
        // Event listeners
        filtroInput.addEventListener('input', aplicarFiltros);
        
        limpiarBtn.addEventListener('click', function() {
            filtroInput.value = '';
            filtroInput.focus();
            aplicarFiltros();
        });
        
        // Filtros rápidos
        document.querySelectorAll('.filtro-rapido').forEach(btn => {
            btn.addEventListener('click', function() {
                // Cambiar filtro activo
                document.querySelectorAll('.filtro-rapido').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                // Aplicar filtros
                aplicarFiltros();
            });
        });
        
        // Aplicar filtros iniciales
        aplicarFiltros();
    }
    
    function inicializarSelectoresBusqueda() {
        document.querySelectorAll('.search-input').forEach(input => {
            const position = input.dataset.position;
            const dropdown = document.getElementById(`dropdown_${position}`);
            const hiddenInput = input.nextElementSibling;
            
            // Mostrar dropdown al hacer focus
            input.addEventListener('focus', function() {
                dropdown.style.display = 'block';
                filtrarOpciones(this.value, dropdown);
            });
            
            // Filtrar opciones mientras se escribe
            input.addEventListener('input', function() {
                filtrarOpciones(this.value, dropdown);
            });
            
            // Ocultar dropdown al perder focus (con delay para permitir clicks)
            input.addEventListener('blur', function() {
                setTimeout(() => {
                    dropdown.style.display = 'none';
                }, 200);
            });
            
            // Manejar selección de opciones
            dropdown.addEventListener('click', function(e) {
                if (e.target.classList.contains('select-option') && !e.target.classList.contains('disabled')) {
                    const value = e.target.dataset.value;
                    const text = e.target.textContent.trim();
                    
                    hiddenInput.value = value;
                    input.value = value === 'random' ? '' : text;
                    dropdown.style.display = 'none';
                    
                    // Disparar evento change
                    hiddenInput.dispatchEvent(new Event('change'));
                }
            });
        });
    }
    
    function filtrarOpciones(termino, dropdown) {
        const opciones = dropdown.querySelectorAll('.select-option');
        termino = termino.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, ''); // Normalizar acentos
        let opcionesVisibles = 0;
        
        opciones.forEach(opcion => {
            const texto = opcion.textContent.toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const searchData = (opcion.dataset.search || '').toLowerCase().normalize('NFD').replace(/[\u0300-\u036f]/g, '');
            const esRandom = opcion.dataset.value === 'random';
            const esBye = opcion.dataset.value === 'bye';
            
            // Mostrar sempre las opciones especiales (random y bye)
            if (esRandom || esBye) {
                opcion.style.display = 'block';
                opcionesVisibles++;
            } else if (termino === '' || texto.includes(termino) || searchData.includes(termino)) {
                opcion.style.display = 'block';
                opcionesVisibles++;
                
                // Resaltar coincidencias
                if (termino !== '') {
                    const nombre = opcion.textContent;
                    const regex = new RegExp(`(${termino})`, 'gi');
                    const nombreResaltado = nombre.replace(regex, '<mark>$1</mark>');
                    opcion.innerHTML = nombreResaltado;
                } else {
                    opcion.textContent = opcion.textContent; // Limpiar marcado
                }
            } else {
                opcion.style.display = 'none';
            }
        });
        
        // Mostrar mensaje si no hay resultados (excluyendo opciones especiales)
        const mensajeNoResultados = dropdown.querySelector('.no-resultados-dropdown');
        if (mensajeNoResultados) {
            mensajeNoResultados.remove();
        }
        
        if (opcionesVisibles <= 2 && termino !== '') { // Solo random y bye visibles
            const mensaje = document.createElement('div');
            mensaje.className = 'no-resultados-dropdown text-muted text-center p-2';
            mensaje.innerHTML = '<i class="fas fa-search"></i> No se encontraron jugadores';
            dropdown.appendChild(mensaje);
        }
    }
    
    function actualizarEstadoParticipantes() {
        const hiddenInputs = document.querySelectorAll('.jugador-hidden');
        const jugadoresAsignados = new Map(); // Usar Map para guardar jugador -> posición
        
        // Recopilar jugadores asignados con sus posiciones
        hiddenInputs.forEach(input => {
            const checkbox = document.querySelector(`input[name="bye_${input.dataset.position}"]`);
            if (!checkbox.checked && input.value !== 'random' && input.value !== '') {
                jugadoresAsignados.set(input.value, input.dataset.position);
            }
        });
        
        // Actualizar estado en la lista de participantes
        document.querySelectorAll('.participante-item').forEach(item => {
            const jugadorId = item.dataset.jugadorId;
            const statusBadge = item.querySelector('.status-badge');
            const asignarBtn = item.querySelector('.asignar-btn');
            const posicionSpan = item.querySelector('.posicion-asignada');
            const numeroPos = item.querySelector('.numero-posicion');
            
            if (jugadoresAsignados.has(jugadorId)) {
                const posicion = jugadoresAsignados.get(jugadorId);
                
                // Actualizar visual
                item.classList.add('asignado');
                item.dataset.estado = 'asignado';
                statusBadge.textContent = 'Asignado';
                statusBadge.className = 'badge bg-info status-badge';
                
                // Mostrar posición
                if (numeroPos) {
                    numeroPos.textContent = posicion;
                    posicionSpan.style.display = 'inline-block';
                }
                
                // Cambiar botón a "quitar"
                asignarBtn.innerHTML = '<i class="fas fa-times"></i>';
                asignarBtn.classList.add('btn-danger');
                asignarBtn.classList.remove('btn-outline-primary');
                asignarBtn.title = 'Quitar de la posición ' + posicion;
            } else {
                item.classList.remove('asignado');
                item.dataset.estado = 'disponible';
                statusBadge.textContent = 'Disponible';
                statusBadge.className = 'badge bg-success status-badge';
                
                // Ocultar posición
                if (posicionSpan) {
                    posicionSpan.style.display = 'none';
                }
                
                // Cambiar botón a "asignar"
                asignarBtn.innerHTML = '<i class="fas fa-plus"></i>';
                asignarBtn.classList.remove('btn-danger');
                asignarBtn.classList.add('btn-outline-primary');
                asignarBtn.title = 'Asignar a primera posición disponible';
            }
        });
        
        // Actualizar contadores
        const totalJugadores = document.querySelectorAll('.participante-item').length;
        const asignados = jugadoresAsignados.size;
        const disponibles = totalJugadores - asignados;
        
        document.getElementById('count-disponibles').textContent = disponibles;
        document.getElementById('count-asignados').textContent = asignados;
        
        // Actualizar filtros si están activos
        const filtroActivo = document.querySelector('.filtro-rapido.active');
        if (filtroActivo && filtroActivo.dataset.filtro !== 'todos') {
            const filtroInput = document.getElementById('filtro-jugadores');
            if (filtroInput) {
                filtroInput.dispatchEvent(new Event('input'));
            }
        }
    }
    
    function inicializarBotonesAsignar() {
        document.querySelectorAll('.asignar-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const jugadorId = this.dataset.jugadorId;
                const jugadorNombre = this.dataset.jugadorNombre;
                const hiddenInputs = document.querySelectorAll('.jugador-hidden');
                
                // Verificar si el jugador ya está asignado
                let jugadorAsignado = false;
                let posicionActual = null;
                
                for (let input of hiddenInputs) {
                    if (input.value === jugadorId) {
                        jugadorAsignado = true;
                        posicionActual = input.dataset.position;
                        break;
                    }
                }
                
                if (jugadorAsignado) {
                    // Quitar jugador de su posición actual
                    const inputActual = document.querySelector(`.jugador-hidden[data-position="${posicionActual}"]`);
                    const searchInputActual = inputActual.previousElementSibling;
                    
                    inputActual.value = 'random';
                    searchInputActual.value = '';
                    
                    // Disparar evento change
                    inputActual.dispatchEvent(new Event('change'));
                    
                    // Mostrar feedback
                    this.style.transform = 'scale(1.2)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 200);
                    
                } else {
                    // Buscar primera posición disponible (no BYE y aleatorio)
                    let posicionEncontrada = false;
                    
                    for (let input of hiddenInputs) {
                        const position = input.dataset.position;
                        const checkbox = document.querySelector(`input[name="bye_${position}"]`);
                        
                        if (!checkbox.checked && input.value === 'random') {
                            // Asignar jugador a esta posición
                            input.value = jugadorId;
                            const searchInput = input.previousElementSibling;
                            searchInput.value = jugadorNombre;
                            
                            // Disparar evento change
                            input.dispatchEvent(new Event('change'));
                            
                            posicionEncontrada = true;
                            
                            // Mostrar feedback visual
                            this.style.transform = 'scale(1.2)';
                            setTimeout(() => {
                                this.style.transform = 'scale(1)';
                            }, 200);
                            
                            break;
                        }
                    }
                    
                    if (!posicionEncontrada) {
                        // Mostrar notificación más elegante
                        mostrarNotificacion('No hay posiciones disponibles para asignar este jugador.', 'warning');
                    }
                }
            });
        });
    }
    
    function mostrarNotificacion(mensaje, tipo = 'info') {
        const alertasContainer = document.getElementById('alertas-container');
        const alerta = document.createElement('div');
        alerta.className = `alert alert-${tipo === 'warning' ? 'warning' : 'info'} alert-dismissible fade show`;
        alerta.innerHTML = `
            <i class="fas fa-${tipo === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
            ${mensaje}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        alertasContainer.appendChild(alerta);
        
        // Auto-dismiss después de 3 segundos
        setTimeout(() => {
            if (alerta.parentNode) {
                alerta.remove();
            }
        }, 3000);
    }
    
    function inicializarOrdenamiento() {
        const ordenarPor = document.getElementById('ordenar-por');
        const ordenDireccion = document.getElementById('orden-direccion');
        const listaContainer = document.querySelector('#lista-participantes .list-group');
        
        function ordenarLista() {
            const criterio = ordenarPor.value;
            const direccion = ordenDireccion.value;
            const items = Array.from(document.querySelectorAll('.participante-item'));
            
            items.sort((a, b) => {
                let valorA, valorB;
                
                switch(criterio) {
                    case 'nombre':
                        valorA = a.querySelector('.jugador-nombre').textContent.trim().split(' ')[0];
                        valorB = b.querySelector('.jugador-nombre').textContent.trim().split(' ')[0];
                        break;
                    case 'apellido':
                        const nombresA = a.querySelector('.jugador-nombre').textContent.trim().split(' ');
                        const nombresB = b.querySelector('.jugador-nombre').textContent.trim().split(' ');
                        valorA = nombresA[nombresA.length - 1];
                        valorB = nombresB[nombresB.length - 1];
                        break;
                    case 'club':
                        const clubA = a.querySelector('small.text-muted');
                        const clubB = b.querySelector('small.text-muted');
                        valorA = clubA ? clubA.textContent.replace(/.*\s/, '').trim() : '';
                        valorB = clubB ? clubB.textContent.replace(/.*\s/, '').trim() : '';
                        break;
                    case 'estado':
                        valorA = a.dataset.estado || 'disponible';
                        valorB = b.dataset.estado || 'disponible';
                        break;
                    default:
                        valorA = a.querySelector('.jugador-nombre').textContent.trim();
                        valorB = b.querySelector('.jugador-nombre').textContent.trim();
                }
                
                const comparacion = valorA.localeCompare(valorB, 'es', { sensitivity: 'base' });
                return direccion === 'asc' ? comparacion : -comparacion;
            });
            
            // Reordenar elementos en el DOM
            items.forEach(item => listaContainer.appendChild(item));
            
            // Aplicar animación suave
            listaContainer.style.opacity = '0.7';
            setTimeout(() => {
                listaContainer.style.opacity = '1';
            }, 200);
        }
        
        ordenarPor.addEventListener('change', ordenarLista);
        ordenDireccion.addEventListener('change', ordenarLista);
        
        // Ordenar inicialmente por nombre
        ordenarLista();
    }
    
    function inicializarBracket() {
        const container = document.getElementById('tournament-bracket');
        
        // Intentar usar las librerías profesionales
        try {
            if (typeof BracketTree !== 'undefined' && typeof TournamentBracket !== 'undefined') {
                crearBracketConLibrerias(container);
            } else {
                throw new Error('Librerías no disponibles');
            }
        } catch (error) {
            console.log('Librerías profesionales no disponibles, usando implementación personalizada');
            crearBracketPersonalizado(container);
        }
    }
    
    function crearBracketConLibrerias(container) {
        // Crear estructura de datos con bracket-tree
        const participants = [];
        
        // Agregar participantes reales
        for (let i = 0; i < tamanioBracket; i++) {
            participants.push({
                id: `pos_${i}`,
                name: `Posición ${i + 1}`,
                position: i,
                isAssigned: false,
                isBye: false
            });
        }
        
        // Inicializar bracket-tree para manipulación de datos
        try {
            bracketTree = new BracketTree({
                participants: participants,
                rounds: Math.log2(tamanioBracket)
            });
        } catch (e) {
            console.log('BracketTree no disponible, usando datos simples');
        }
        
        // Generar datos para tournament-bracket
        const bracketData = generarDatosBracketProfesional();
        
        // Configuración visual
        const config = {
            teamWidth: 150,
            teamHeight: 35,
            teamGap: 20,
            roundGap: 100,
            connectorColor: '#007bff',
            connectorWidth: 2,
            teamBackgroundColor: '#ffffff',
            teamBorderColor: '#dee2e6',
            teamTextColor: '#212529',
            byeBackgroundColor: '#f8f9fa',
            byeTextColor: '#6c757d'
        };
        
        // Crear visualización con tournament-bracket
        tournamentBracket = new TournamentBracket(container, bracketData, config);
        
        // Agregar interactividad
        agregarInteractividadBracket();
    }
    
    function generarDatosBracketProfesional() {
        const rondas = Math.log2(tamanioBracket);
        const bracket = [];
        
        // Primera ronda
        const partidosPrimeraRonda = tamanioBracket / 2;
        const primeraRonda = [];
        
        for (let i = 0; i < partidosPrimeraRonda; i++) {
            const pos1 = i * 2;
            const pos2 = i * 2 + 1;
            
            primeraRonda.push({
                id: `r1-m${i}`,
                teams: [
                    {
                        id: `pos${pos1}`,
                        name: `Posición ${pos1 + 1}`,
                        isBye: false,
                        position: pos1,
                        isAssigned: false
                    },
                    {
                        id: `pos${pos2}`,
                        name: `Posición ${pos2 + 1}`,
                        isBye: false,
                        position: pos2,
                        isAssigned: false
                    }
                ]
            });
        }
        
        bracket.push({
            round: 1,
            name: 'Primera Ronda',
            matches: primeraRonda
        });
        
        // Rondas siguientes
        for (let ronda = 2; ronda <= rondas; ronda++) {
            const partidosRonda = tamanioBracket / Math.pow(2, ronda);
            const matches = [];
            
            for (let i = 0; i < partidosRonda; i++) {
                let nombre = 'TBD';
                if (ronda === rondas) {
                    nombre = 'Final';
                } else if (ronda === rondas - 1) {
                    nombre = 'Semifinal';
                } else {
                    nombre = `Ronda ${ronda}`;
                }
                
                matches.push({
                    id: `r${ronda}-m${i}`,
                    teams: [
                        { 
                            id: `r${ronda}-t${i}-1`, 
                            name: 'Por definir', 
                            isBye: false,
                            isAssigned: false
                        },
                        { 
                            id: `r${ronda}-t${i}-2`, 
                            name: 'Por definir', 
                            isBye: false,
                            isAssigned: false
                        }
                    ]
                });
            }
            
            bracket.push({
                round: ronda,
                name: ronda === rondas ? 'Final' : (ronda === rondas - 1 ? 'Semifinal' : `Ronda ${ronda}`),
                matches: matches
            });
        }
        
        return bracket;
    }
    
    function agregarInteractividadBracket() {
        // Agregar interactividad para hacer clic en posiciones del bracket
        if (tournamentBracket && tournamentBracket.container) {
            const teams = tournamentBracket.container.querySelectorAll('.team, .match-team');
            teams.forEach(team => {
                const posicionData = team.textContent.match(/Posición (\d+)/);
                if (posicionData) {
                    const posicion = parseInt(posicionData[1]) - 1;
                    team.style.cursor = 'pointer';
                    team.addEventListener('click', function() {
                        resaltarPosicionEnFormulario(posicion);
                    });
                }
            });
        }
    }
    
    function resaltarPosicionEnFormulario(posicion) {
        // Quitar resaltado anterior
        document.querySelectorAll('.bracket-select.highlighted').forEach(select => {
            select.classList.remove('highlighted');
        });
        
        // Resaltar la posición correspondiente
        const select = document.querySelector(`select[name="casilla_${posicion}"]`);
        if (select) {
            select.classList.add('highlighted');
            select.scrollIntoView({ behavior: 'smooth', block: 'center' });
            select.focus();
        }
    }
    
    function crearBracketPersonalizado(container) {
        container.innerHTML = '<div class="bracket-simple"></div>';
        const bracketDiv = container.querySelector('.bracket-simple');
        bracketDiv.style.cssText = 'display: flex; overflow-x: auto; padding: 20px; gap: 20px;';
        
        const rondas = Math.log2(tamanioBracket);
        
        for (let ronda = 1; ronda <= rondas; ronda++) {
            const roundDiv = document.createElement('div');
            roundDiv.className = 'round-column';
            roundDiv.style.cssText = 'display: flex; flex-direction: column; min-width: 160px;';
            
            const titleDiv = document.createElement('div');
            titleDiv.className = 'round-title';
            titleDiv.style.cssText = `
                text-align: center; 
                font-weight: bold; 
                margin-bottom: 15px; 
                background: linear-gradient(135deg, #007bff, #0056b3); 
                color: white; 
                padding: 10px; 
                border-radius: 8px;
                box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            `;
            
            if (ronda === 1) {
                titleDiv.textContent = 'Primera Ronda';
            } else if (ronda === rondas) {
                titleDiv.textContent = 'Final';
            } else if (ronda === rondas - 1) {
                titleDiv.textContent = 'Semifinal';
            } else {
                titleDiv.textContent = `Ronda ${ronda}`;
            }
            
            roundDiv.appendChild(titleDiv);
            
            const partidosRonda = tamanioBracket / Math.pow(2, ronda);
            
            for (let i = 0; i < partidosRonda; i++) {
                const matchDiv = document.createElement('div');
                matchDiv.className = 'match';
                matchDiv.style.cssText = `
                    border: 2px solid #dee2e6; 
                    border-radius: 8px; 
                    background: white; 
                    margin: 8px 0; 
                    min-width: 140px;
                    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
                    transition: all 0.2s ease;
                `;
                
                matchDiv.addEventListener('mouseenter', function() {
                    this.style.borderColor = '#007bff';
                    this.style.boxShadow = '0 4px 8px rgba(0,123,255,0.2)';
                });
                
                matchDiv.addEventListener('mouseleave', function() {
                    this.style.borderColor = '#dee2e6';
                    this.style.boxShadow = '0 2px 4px rgba(0,0,0,0.05)';
                });
                
                if (ronda === 1) {
                    const pos1 = i * 2;
                    const pos2 = i * 2 + 1;
                    
                    const team1 = crearEquipo(pos1, true);
                    const vs = crearSeparadorVS();
                    const team2 = crearEquipo(pos2, true);
                    
                    matchDiv.appendChild(team1);
                    matchDiv.appendChild(vs);
                    matchDiv.appendChild(team2);
                } else {
                    const team1 = crearEquipoTBD();
                    const vs = crearSeparadorVS();
                    const team2 = crearEquipoTBD();
                    
                    matchDiv.appendChild(team1);
                    matchDiv.appendChild(vs);
                    matchDiv.appendChild(team2);
                }
                
                roundDiv.appendChild(matchDiv);
            }
            
            bracketDiv.appendChild(roundDiv);
        }
    }
    
    function crearEquipo(posicion, esSeleccionable) {
        const team = document.createElement('div');
        team.className = 'team';
        team.dataset.position = posicion;
        
        if (esSeleccionable) {
            team.style.cssText = `
                padding: 12px; 
                border-bottom: 1px solid #eee; 
                font-size: 13px; 
                cursor: pointer;
                transition: background-color 0.2s ease;
            `;
            team.textContent = `Pos. ${posicion + 1}`;
            
            team.addEventListener('click', function() {
                resaltarPosicionEnFormulario(posicion);
            });
            
            team.addEventListener('mouseenter', function() {
                this.style.backgroundColor = '#e3f2fd';
            });
            
            team.addEventListener('mouseleave', function() {
                this.style.backgroundColor = 'white';
            });
        } else {
            team.style.cssText = `
                padding: 12px; 
                border-bottom: 1px solid #eee; 
                font-size: 13px; 
                background-color: #f8f9fa; 
                color: #6c757d; 
                font-style: italic;
            `;
            team.textContent = 'BYE';
        }
        
        return team;
    }
    
    function crearEquipoTBD() {
        const team = document.createElement('div');
        team.className = 'team';
        team.style.cssText = `
            padding: 12px; 
            border-bottom: 1px solid #eee; 
            font-size: 13px; 
            font-style: italic; 
            color: #adb5bd;
            background-color: #fafafa;
        `;
        team.textContent = 'Por definir';
        return team;
    }
    
    function crearSeparadorVS() {
        const vs = document.createElement('div');
        vs.style.cssText = `
            text-align: center; 
            font-size: 10px; 
            color: #007bff; 
            padding: 4px; 
            background: linear-gradient(90deg, #f8f9fa, #e9ecef, #f8f9fa);
            font-weight: bold;
        `;
        vs.textContent = 'VS';
        return vs;
    }
    
    function actualizarBracket() {
        // Actualizar la primera ronda con las selecciones
        const matches = document.querySelectorAll('.round-column:first-child .match');
        
        matches.forEach((match, index) => {
            const pos1 = index * 2;
            const pos2 = index * 2 + 1;
            
            const select1 = document.querySelector(`select[name="casilla_${pos1}"]`);
            const select2 = document.querySelector(`select[name="casilla_${pos2}"]`);
            
            const teams = match.querySelectorAll('.team');
            
            if (teams.length >= 2) {
                actualizarEquipoEnBracket(teams[0], select1, pos1);
                actualizarEquipoEnBracket(teams[1], select2, pos2);
            }
        });
        
        // Si tenemos bracket-tree, actualizar también los datos
        if (bracketTree) {
            actualizarDatosBracketTree();
        }
        
        // Si tenemos tournament-bracket profesional, actualizar también
        if (tournamentBracket && tournamentBracket.update) {
            try {
                const nuevoDatos = generarDatosBracketProfesional();
                tournamentBracket.update(nuevoDatos);
            } catch (e) {
                console.log('Error actualizando tournament-bracket:', e);
            }
        }
    }
    
    function actualizarEquipoEnBracket(teamElement, select, posicion) {
        if (!select) return;
        
        const checkbox = document.querySelector(`input[name="bye_${posicion}"]`);
        const isBye = checkbox && checkbox.checked;
        
        if (isBye) {
            // BYE marcado con checkbox
            teamElement.textContent = 'BYE';
            teamElement.style.cssText = `
                padding: 12px; 
                border-bottom: 1px solid #eee; 
                font-size: 13px; 
                background-color: #f8f9fa; 
                color: #6c757d; 
                font-style: italic;
            `;
        } else if (select.value === 'random') {
            // Posición aleatoria
            teamElement.textContent = `Pos. ${posicion + 1} (Aleatorio)`;
            teamElement.style.cssText = `
                padding: 12px; 
                border-bottom: 1px solid #eee; 
                font-size: 13px; 
                background-color: #fff3cd; 
                color: #856404;
                cursor: pointer;
                transition: background-color 0.2s ease;
            `;
        } else {
            // Jugador asignado manualmente
            const selectedText = select.options[select.selectedIndex].text;
            teamElement.textContent = selectedText;
            teamElement.style.cssText = `
                padding: 12px; 
                border-bottom: 1px solid #eee; 
                font-size: 13px; 
                background-color: #d1ecf1; 
                color: #0c5460;
                font-weight: bold;
                cursor: pointer;
                transition: background-color 0.2s ease;
            `;
        }
        
        // Re-agregar event listeners solo si no es BYE
        if (!isBye) {
            teamElement.onclick = function() {
                resaltarPosicionEnFormulario(posicion);
            };
        } else {
            teamElement.onclick = null;
        }
    }
    
    function actualizarDatosBracketTree() {
        if (!bracketTree) return;
        
        // Actualizar participantes en bracket-tree basado en las selecciones
        const selects = document.querySelectorAll('select[name^="casilla_"]');
        
        selects.forEach((select, index) => {
            if (index < numParticipantes) {
                try {
                    const participant = bracketTree.getParticipant(`pos_${index}`);
                    if (participant) {
                        if (select.value === 'random') {
                            participant.isAssigned = false;
                            participant.name = `Posición ${index + 1}`;
                        } else {
                            participant.isAssigned = true;
                            participant.name = select.options[select.selectedIndex].text;
                            participant.playerId = select.value;
                        }
                    }
                } catch (e) {
                    console.log('Error actualizando participant:', e);
                }
            }
        });
    }
    
    function autocompletarBYEs() {
        const checkboxes = document.querySelectorAll('input[name^="bye_"]');
        const byesNecesarios = tamanioBracket - numParticipantes;
        let byesActuales = 0;
        
        // Contar BYEs actuales
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                byesActuales++;
            }
        });
        
        const byesFaltantes = byesNecesarios - byesActuales;
        
        if (byesFaltantes <= 0) {
            alert('Ya tienes suficientes BYEs seleccionados.');
            return;
        }
        
        if (confirm(`Se seleccionarán automáticamente ${byesFaltantes} BYEs adicionales en posiciones aleatorias. ¿Continuar?`)) {
            const checkboxesDisponibles = Array.from(checkboxes).filter(cb => !cb.checked && !cb.disabled);
            
            // Mezclar las posiciones disponibles
            for (let i = checkboxesDisponibles.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [checkboxesDisponibles[i], checkboxesDisponibles[j]] = [checkboxesDisponibles[j], checkboxesDisponibles[i]];
            }
            
            // Seleccionar los BYEs faltantes
            for (let i = 0; i < Math.min(byesFaltantes, checkboxesDisponibles.length); i++) {
                checkboxesDisponibles[i].checked = true;
                // Disparar evento change para actualizar la interfaz
                checkboxesDisponibles[i].dispatchEvent(new Event('change'));
            }
            
            // Actualizar contadores
            actualizarContadores();
            validarLimiteByes();
        }
    }
    
    // Agregar función para asignación aleatoria avanzada
    function asignacionAleatoriaAvanzada() {
        const jugadoresDisponibles = [...jugadores];
        const posicionesAleatorias = [];
        const checkboxes = document.querySelectorAll('input[name^="bye_"]');
        
        // Encontrar posiciones que están en "random" y no son BYE
        const selects = document.querySelectorAll('select[name^="casilla_"]');
        selects.forEach((select, index) => {
            const checkbox = document.querySelector(`input[name="bye_${index}"]`);
            if (!checkbox.checked && select.value === 'random') {
                posicionesAleatorias.push(index);
            }
        });
        
        // Mezclar jugadores disponibles
        for (let i = jugadoresDisponibles.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [jugadoresDisponibles[i], jugadoresDisponibles[j]] = [jugadoresDisponibles[j], jugadoresDisponibles[i]];
        }
        
        // Mezclar posiciones aleatorias
        for (let i = posicionesAleatorias.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [posicionesAleatorias[i], posicionesAleatorias[j]] = [posicionesAleatorias[j], posicionesAleatorias[i]];
        }
        
        // Calcular cuántos BYEs adicionales necesitamos
        const byesActuales = Array.from(checkboxes).filter(cb => cb.checked).length;
        const byesMaximos = tamanioBracket - numParticipantes;
        const byesAdicionales = Math.max(0, byesMaximos - byesActuales);
        const posicionesParaJugadores = posicionesAleatorias.slice(0, Math.min(jugadoresDisponibles.length, posicionesAleatorias.length - byesAdicionales));
        const posicionesParaByes = posicionesAleatorias.slice(posicionesParaJugadores.length, posicionesParaJugadores.length + byesAdicionales);
        
        // Asignar jugadores a posiciones aleatorias
        posicionesParaJugadores.forEach((posicion, index) => {
            const select = document.querySelector(`select[name="casilla_${posicion}"]`);
            if (select && index < jugadoresDisponibles.length) {
                select.value = jugadoresDisponibles[index].id;
            }
        });
        
        // Marcar BYEs adicionales si es necesario
        posicionesParaByes.forEach(posicion => {
            const checkbox = document.querySelector(`input[name="bye_${posicion}"]`);
            if (checkbox) {
                checkbox.checked = true;
            }
        });
        
        actualizarOpcionesDisponibles();
        actualizarBracket();
    }
    
    // Funciones de validación y manejo de eventos
    function actualizarOpcionesDisponibles() {
        const hiddenInputs = document.querySelectorAll('.jugador-hidden');
        const checkboxes = document.querySelectorAll('input[name^="bye_"]');
        const jugadoresSeleccionados = new Set();
        
        // Contar BYEs actuales y calcular máximo permitido
        let byesActuales = 0;
        const byesMaximos = tamanioBracket - numParticipantes;
        
        // Contar BYEs marcados
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                byesActuales++;
            }
        });
        
        // Identificar jugadores seleccionados (solo en posiciones que no son BYE)
        hiddenInputs.forEach((input, index) => {
            const checkbox = document.querySelector(`input[name="bye_${index}"]`);
            const valor = input.value;
            
            if (!checkbox.checked && valor && valor !== 'random') {
                jugadoresSeleccionados.add(valor);
            }
        });
        
        // Actualizar tarjetas con estilos según estado
        hiddenInputs.forEach((input, index) => {
            const checkbox = document.querySelector(`input[name="bye_${index}"]`);
            const card = input.closest('.posicion-card');
            
            // Deshabilitar/habilitar inputs según checkbox
            if (checkbox.checked) {
                card.classList.add('bye-selected');
                card.classList.remove('jugador-selected');
            } else if (input.value && input.value !== 'random') {
                card.classList.add('jugador-selected');
                card.classList.remove('bye-selected');
            } else {
                card.classList.remove('jugador-selected', 'bye-selected');
            }
        });
        
        actualizarContadores();
        actualizarEstadoParticipantes();
    }
    
    function mostrarAlertas(hayDuplicados, excesoByes) {
        const alertasContainer = document.getElementById('alertas-container');
        const btnConfirmar = document.getElementById('btn-confirmar');
        
        // Limpiar alertas anteriores
        const alertasDuplicados = document.getElementById('alerta-duplicados');
        const alertasByes = document.getElementById('alerta-byes');
        if (alertasDuplicados) alertasDuplicados.remove();
        if (alertasByes) alertasByes.remove();
        
        let hayErrores = false;
        
        // Alerta por jugadores duplicados
        if (hayDuplicados) {
            hayErrores = true;
            const alerta = document.createElement('div');
            alerta.id = 'alerta-duplicados';
            alerta.className = 'alert alert-warning alert-dismissible fade show';
            alerta.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Atención:</strong> Hay jugadores seleccionados en múltiples posiciones.
                <br><small>Cambia las selecciones duplicadas antes de continuar.</small>
            `;
            alertasContainer.appendChild(alerta);
        }
        
        // Alerta por exceso de BYEs
        if (excesoByes) {
            hayErrores = true;
            const byesMaximos = tamanioBracket - numParticipantes;
            const alerta = document.createElement('div');
            alerta.id = 'alerta-byes';
            alerta.className = 'alert alert-danger alert-dismissible fade show';
            alerta.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <strong>Error:</strong> Has seleccionado demasiados BYEs.
                <br><small>Máximo permitido: ${byesMaximos} BYEs. Cambia algunas selecciones a jugadores o aleatorio.</small>
            `;
            alertasContainer.appendChild(alerta);
        }
        
        // Actualizar estado del botón
        if (hayErrores) {
            btnConfirmar.disabled = true;
            if (hayDuplicados && excesoByes) {
                btnConfirmar.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Corrige duplicados y BYEs';
            } else if (hayDuplicados) {
                btnConfirmar.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Corrige los duplicados';
            } else if (excesoByes) {
                btnConfirmar.innerHTML = '<i class="fas fa-exclamation-circle"></i> Reduce los BYEs';
            }
        } else {
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar Asignación';
        }
    }
    
    function actualizarContadores() {
        const hiddenInputs = document.querySelectorAll('.jugador-hidden');
        const checkboxes = document.querySelectorAll('input[name^="bye_"]');
        let jugadoresAsignados = 0;
        let byesCount = 0;
        let aleatoriosCount = 0;
        
        // Contar BYEs marcados con checkbox
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                byesCount++;
            }
        });
        
        // Contar jugadores asignados manualmente
        hiddenInputs.forEach((input, index) => {
            const checkbox = document.querySelector(`input[name="bye_${index}"]`);
            const valor = input.value;
            
            if (!checkbox.checked) {
                if (valor && valor !== 'random' && valor !== '') {
                    jugadoresAsignados++;
                } else {
                    aleatoriosCount++;
                }
            }
        });
        
        // Actualizar contadores principales
        const countJugadores = document.getElementById('count-jugadores');
        const countByesHeader = document.getElementById('count-byes-header');
        const countByes = document.getElementById('count-byes');
        const countAleatorios = document.getElementById('count-aleatorios');
        
        if (countJugadores) countJugadores.textContent = jugadoresAsignados;
        if (countByesHeader) countByesHeader.textContent = byesCount;
        if (countByes) countByes.textContent = byesCount;
        if (countAleatorios) countAleatorios.textContent = aleatoriosCount;
        
        // Calcular BYEs necesarios
        const byesNecesarios = tamanioBracket - numParticipantes;
        
        // Actualizar alerta de BYEs requeridos
        const alertaByes = document.getElementById('alerta-byes-requeridos');
        const estadoByesTexto = document.getElementById('estado-byes-texto');
        const byesRequeridos = document.getElementById('byes-requeridos');
        
        if (byesRequeridos) {
            byesRequeridos.textContent = byesNecesarios;
        }
        
        if (estadoByesTexto) {
            if (byesCount === 0) {
                estadoByesTexto.textContent = 'No hay BYEs seleccionados';
                estadoByesTexto.className = 'text-muted';
            } else if (byesCount < byesNecesarios) {
                estadoByesTexto.textContent = `${byesCount}/${byesNecesarios} BYEs seleccionados - Faltan ${byesNecesarios - byesCount}`;
                estadoByesTexto.className = 'text-warning fw-bold';
            } else if (byesCount === byesNecesarios) {
                estadoByesTexto.textContent = `${byesCount}/${byesNecesarios} BYEs seleccionados - ¡Perfecto!`;
                estadoByesTexto.className = 'text-success fw-bold';
            } else {
                estadoByesTexto.textContent = `${byesCount}/${byesNecesarios} BYEs seleccionados - Exceso de ${byesCount - byesNecesarios}`;
                estadoByesTexto.className = 'text-danger fw-bold';
            }
        }
        
        if (alertaByes) {
            if (byesCount === byesNecesarios) {
                alertaByes.className = 'alert alert-success mb-0';
            } else if (byesCount < byesNecesarios) {
                alertaByes.className = 'alert alert-warning mb-0';
            } else {
                alertaByes.className = 'alert alert-danger mb-0';
            }
        }
        
        // Actualizar contadores del header
        if (countByesHeader) {
            if (byesCount > byesNecesarios) {
                countByesHeader.className = 'd-block fw-bold text-danger fs-4';
            } else if (byesCount === byesNecesarios) {
                countByesHeader.className = 'd-block fw-bold text-success fs-4';
            } else {
                countByesHeader.className = 'd-block fw-bold text-warning fs-4';
            }
        }
        
        if (countByes) {
            if (byesCount > byesNecesarios) {
                countByes.className = 'd-block fw-bold text-danger';
            } else if (byesCount === byesNecesarios) {
                countByes.className = 'd-block fw-bold text-success';
            } else {
                countByes.className = 'd-block fw-bold text-warning';
            }
        }
        
        // Validar formulario
        validarLimiteByes();
    }
    
    // Función para actualizar la información del bracket
    function actualizarInformacionBracket() {
        const byesNecesarios = tamanioBracket - numParticipantes;
        const partidosPrimeraRonda = numParticipantes > tamanioBracket / 2 ? tamanioBracket / 2 : Math.floor(numParticipantes / 2);
        
        console.log('Actualizando información del bracket:');
        console.log('- Participantes:', numParticipantes);
        console.log('- Tamaño bracket:', tamanioBracket);
        console.log('- BYEs necesarios:', byesNecesarios);
        console.log('- Partidos primera ronda:', partidosPrimeraRonda);
        
        // Actualizar elementos de información del bracket
        const byesNecesariosElement = document.getElementById('byes-necesarios');
        const partidosPrimeraRondaElement = document.getElementById('partidos-primera-ronda');
        
        if (byesNecesariosElement) {
            byesNecesariosElement.textContent = byesNecesarios;
            byesNecesariosElement.style.fontWeight = 'bold';
        }
        
        if (partidosPrimeraRondaElement) {
            partidosPrimeraRondaElement.textContent = partidosPrimeraRonda;
            partidosPrimeraRondaElement.style.fontWeight = 'bold';
        }
    }

    // Event listeners para checkboxes de BYE
    document.querySelectorAll('input[name^="bye_"]').forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            actualizarOpcionesDisponibles();
            actualizarBracket();
        });
    });
    
    // Botón de auto-completar BYEs
    document.getElementById('btn-autocompletar-byes').addEventListener('click', function() {
        autocompletarBYEs();
    });
    
    // Botón de asignación aleatoria
    document.getElementById('btn-asignacion-aleatoria').addEventListener('click', function() {
        if (confirm('¿Estás seguro de que quieres asignar aleatoriamente los jugadores restantes? Esto sobrescribirá las asignaciones marcadas como "Aleatorio".')) {
            asignacionAleatoriaAvanzada();
        }
    });
    
    // Validación del formulario
    document.querySelector('form').addEventListener('submit', function(e) {
        if (!validarFormulario()) {
            e.preventDefault();
        }
    });
    
    function validarFormulario() {
        const selects = document.querySelectorAll('select[name^="casilla_"]');
        const checkboxes = document.querySelectorAll('input[name^="bye_"]');
        const jugadoresSeleccionados = new Set();
        const duplicados = [];
        let byesCount = 0;
        const byesNecesarios = tamanioBracket - numParticipantes;
        
        // Contar BYEs marcados
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                byesCount++;
            }
        });
        
        // Validar duplicados solo en posiciones que no son BYE
        selects.forEach((select, index) => {
            const checkbox = document.querySelector(`input[name="bye_${index}"]`);
            const valor = select.value;
            
            if (!checkbox.checked && valor && valor !== 'random') {
                if (jugadoresSeleccionados.has(valor)) {
                    duplicados.push(`Posición ${index + 1}`);
                } else {
                    jugadoresSeleccionados.add(valor);
                }
            }
        });
        
        const alertasContainer = document.getElementById('alertas-container');
        const alertaError = document.getElementById('alerta-error');
        if (alertaError) alertaError.remove();
        
        // Validar duplicados
        if (duplicados.length > 0) {
            const alerta = document.createElement('div');
            alerta.id = 'alerta-error';
            alerta.className = 'alert alert-danger alert-dismissible fade show';
            alerta.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                <strong>Error:</strong> Hay jugadores duplicados en las siguientes posiciones: ${duplicados.join(', ')}.
                <br><small>Por favor, selecciona jugadores diferentes o deja las posiciones como "Aleatorio".</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertasContainer.appendChild(alerta);
            alerta.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }
        
        // Validar exceso de BYEs
        if (byesCount > byesNecesarios) {
            const alerta = document.createElement('div');
            alerta.id = 'alerta-error';
            alerta.className = 'alert alert-danger alert-dismissible fade show';
            alerta.innerHTML = `
                <i class="fas fa-exclamation-circle"></i>
                <strong>Error:</strong> Has marcado ${byesCount} BYEs, pero solo necesitas ${byesNecesarios}.
                <br><small>Desmarca ${byesCount - byesNecesarios} checkboxes de BYE antes de continuar.</small>
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            alertasContainer.appendChild(alerta);
            alerta.scrollIntoView({ behavior: 'smooth', block: 'center' });
            return false;
        }
        
        // Si hay menos BYEs de los necesarios, mostrar advertencia pero permitir continuar
        if (byesCount < byesNecesarios) {
            const confirmacion = confirm(`Has seleccionado ${byesCount} BYEs, pero necesitas ${byesNecesarios}. 
            
Las ${byesNecesarios - byesCount} posiciones faltantes se completarán automáticamente con jugadores aleatorios.

¿Deseas continuar?`);
            
            if (!confirmacion) {
                return false;
            }
        }
        
        return true;
    }
    
    // Función para validar límite de BYEs
    function validarLimiteByes() {
        const checkboxes = document.querySelectorAll('input[name^="bye_"]');
        const byesNecesarios = tamanioBracket - numParticipantes;
        let byesContados = 0;
        
        checkboxes.forEach(checkbox => {
            if (checkbox.checked) {
                byesContados++;
            }
        });
        
        // Habilitar/deshabilitar checkboxes si se alcanza el límite
        checkboxes.forEach(checkbox => {
            if (!checkbox.checked && byesContados >= byesNecesarios) {
                checkbox.disabled = true;
                const label = checkbox.nextElementSibling;
                if (label) {
                    label.style.opacity = '0.5';
                    label.title = `Ya se han seleccionado los ${byesNecesarios} BYEs necesarios`;
                }
            } else {
                checkbox.disabled = false;
                const label = checkbox.nextElementSibling;
                if (label) {
                    label.style.opacity = '1';
                    label.title = '';
                }
            }
        });
        
        // Actualizar botón de confirmar según el estado de BYEs
        const btnConfirmar = document.getElementById('btn-confirmar');
        if (byesContados > byesNecesarios) {
            btnConfirmar.disabled = true;
            btnConfirmar.innerHTML = '<i class="fas fa-exclamation-circle"></i> Reduce los BYEs';
            btnConfirmar.classList.add('btn-danger');
            btnConfirmar.classList.remove('btn-primary');
        } else if (byesContados < byesNecesarios) {
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = `<i class="fas fa-info-circle"></i> Confirmar (Faltan ${byesNecesarios - byesContados} BYEs)`;
            btnConfirmar.classList.remove('btn-danger');
            btnConfirmar.classList.add('btn-warning');
            btnConfirmar.classList.remove('btn-primary');
        } else {
            btnConfirmar.disabled = false;
            btnConfirmar.innerHTML = '<i class="fas fa-check"></i> Confirmar
                    <strong>Información:</strong> Necesitas seleccionar ${byesNecesarios - byesActuales} BYEs más.
                    <br><small>El sistema completará automáticamente las posiciones faltantes con jugadores aleatorios si no seleccionas más BYEs.</small>
                `;
            } else if (byesActuales > byesNecesarios) {
                alerta.className = 'alert alert-danger alert-dismissible fade show';
                alerta.innerHTML = `
                    <i class="fas fa-exclamation-circle"></i>
                    <strong>Error:</strong> Has seleccionado ${byesActuales - byesNecesarios} BYEs de más.
                    <br><small>Desmarca ${byesActuales - byesNecesarios} checkboxes de BYE para continuar.</small>
                `;
            }
            
            alertasContainer.appendChild(alerta);
        }
    }
    
    // Funciones para la nueva interfaz tipo tarjetas
    function inicializarBusquedaTarjetas() {
        document.querySelectorAll('.search-input').forEach(input => {
            const position = input.dataset.position;
            const resultsContainer = input.parentNode.querySelector('.search-results');
            const hiddenInput = input.parentNode.parentNode.querySelector('.jugador-hidden');
            const selectedPlayer = input.parentNode.parentNode.querySelector('.selected-player');
            const card = input.closest('.posicion-card');
            
            // Crear lista de jugadores
            const jugadores = [
                {% for jugador in jugadores %}
                {
                    id: '{{ jugador.id }}',
                    nombre: '{{ jugador.nombre }} {{ jugador.apellido }}',
                    club: '{% if jugador.club %}{{ jugador.club.nombre }}{% endif %}',
                    searchText: '{{ jugador.nombre|lower }} {{ jugador.apellido|lower }} {% if jugador.club %}{{ jugador.club.nombre|lower }}{% endif %}'
                },
                {% endfor %}
            ];
            
            // Mostrar resultados al hacer focus
            input.addEventListener('focus', function() {
                if (!this.disabled) {
                    mostrarResultados(this.value, position, jugadores, resultsContainer);
                }
            });
            
            // Filtrar mientras se escribe
            input.addEventListener('input', function() {
                if (!this.disabled) {
                    mostrarResultados(this.value, position, jugadores, resultsContainer);
                }
            });
            
            // Ocultar resultados al perder focus (con delay)
            input.addEventListener('blur', function() {
                setTimeout(() => {
                    resultsContainer.style.display = 'none';
                }, 200);
            });
            
            // Manejar selección de jugador
            resultsContainer.addEventListener('click', function(e) {
                const item = e.target.closest('.search-result-item');
                if (item) {
                    const jugadorId = item.dataset.jugadorId;
                    const jugadorNombre = item.dataset.jugadorNombre;
                    
                    // Actualizar campos
                    hiddenInput.value = jugadorId;
                    input.value = '';
                    resultsContainer.style.display = 'none';
                    
                    // Mostrar jugador seleccionado
                    selectedPlayer.querySelector('.selected-text').textContent = jugadorNombre;
                    selectedPlayer.style.display = 'block';
                    input.style.display = 'none';
                    
                    // Actualizar estilo de tarjeta
                    card.classList.add('jugador-selected');
                    card.classList.remove('bye-selected');
                    
                    // Actualizar contadores
                    actualizarContadores();
                    actualizarEstadoParticipantes();
                }
            });
            
            // Botón limpiar selección
            const clearBtn = selectedPlayer.querySelector('.clear-selection');
            if (clearBtn) {
                clearBtn.addEventListener('click', function() {
                    hiddenInput.value = 'random';
                    input.value = '';
                    selectedPlayer.style.display = 'none';
                    input.style.display = 'block';
                    
                    // Actualizar estilo de tarjeta
                    card.classList.remove('jugador-selected', 'bye-selected');
                    
                    // Actualizar contadores
                    actualizarContadores();
                    actualizarEstadoParticipantes();
                    
                    input.focus();
                });
            }
        });
    }
    
    function mostrarResultados(termino, position, jugadores, container) {
        termino = termino.toLowerCase().trim();
        
        // Filtrar jugadores
        const jugadoresAsignados = new Set();
        document.querySelectorAll('.jugador-hidden').forEach(input => {
            const checkbox = document.querySelector(`input[name="bye_${input.dataset.position}"]`);
            if (!checkbox.checked && input.value !== 'random' && input.value !== '') {
                jugadoresAsignados.add(input.value);
            }
        });
        
        const resultados = jugadores.filter(j => {
            return !jugadoresAsignados.has(j.id) && 
                   (termino === '' || j.searchText.includes(termino));
        }).slice(0, 8); // Limitar a 8 resultados
        
        // Generar HTML
        let html = '';
        if (resultados.length === 0 && termino !== '') {
            html = '<div class="search-result-item text-muted">No se encontraron jugadores</div>';
        } else {
            resultados.forEach(jugador => {
                html += `
                    <div class="search-result-item" 
                         data-jugador-id="${jugador.id}" 
                         data-jugador-nombre="${jugador.nombre}">
                        <strong>${jugador.nombre}</strong>
                        ${jugador.club ? `<br><small class="text-muted">${jugador.club}</small>` : ''}
                    </div>
                `;
            });
        }
        
        container.innerHTML = html;
        container.style.display = 'block';
    }
    
    function inicializarCheckboxesBYE() {
        document.querySelectorAll('.bye-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                const position = this.dataset.position;
                const card = this.closest('.posicion-card');
                const searchContainer = card.querySelector('.search-container');
                const searchInput = card.querySelector('.search-input');
                const selectedPlayer = card.querySelector('.selected-player');
                const hiddenInput = card.querySelector('.jugador-hidden');
                
                if (this.checked) {
                    // Marcado como BYE
                    searchContainer.style.display = 'none';
                    selectedPlayer.style.display = 'none';
                    searchInput.disabled = true;
                    hiddenInput.value = 'bye';
                    
                    // Actualizar estilo de tarjeta
                    card.classList.add('bye-selected');
                    card.classList.remove('jugador-selected');
                } else {
                    // Desmarcado BYE
                    searchContainer.style.display = 'block';
                    searchInput.disabled = false;
                    hiddenInput.value = 'random';
                    
                    // Actualizar estilo de tarjeta
                    card.classList.remove('bye-selected', 'jugador-selected');
                }
                
                // Actualizar contadores
                actualizarContadores();
                validarLimiteByes();
            });
        });
    }
    
    // Inicialización principal
    inicializarBracket();
    inicializarFiltroJugadores();
    inicializarBusquedaTarjetas();
    inicializarCheckboxesBYE();
    inicializarBotonesAsignar();
    inicializarOrdenamiento();
    
    // Calcular valores informativos
    const byesNecesarios = tamanioBracket - numParticipantes;
    const byesNecesariosElement = document.getElementById('byes-necesarios');
    const byesRequeridos = document.getElementById('byes-requeridos');
    const partidosPrimeraRondaElement = document.getElementById('partidos-primera-ronda');
    
    if (byesNecesariosElement) byesNecesariosElement.textContent = byesNecesarios;
    if (byesRequeridos) byesRequeridos.textContent = byesNecesarios;
    if (partidosPrimeraRondaElement) partidosPrimeraRondaElement.textContent = Math.floor(tamanioBracket / 2);
    
    // Llamar a actualizarContadores para mostrar estado inicial
    actualizarContadores();
    validarLimiteByes();
});
</script>
{% endblock %}
